<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Share Your New Look - PostMyStyle</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
          font-family: 'Helvetica Neue', Arial, sans-serif;
          background: #ffffff;
          text-align: center;
          padding: 20px;
          color: #222;
          margin: 0;
        }
        .container {
          max-width: 600px;
          margin: 0 auto;
          padding: 0 20px;
        }
        .brand-header {
          font-size: 32px;
          font-weight: bold;
          margin-bottom: 15px;
          background: linear-gradient(to right, #3b82f6, #6366f1);
          -webkit-background-clip: text;
          background-clip: text;
          color: transparent;
          display: inline-block;
          text-shadow: 0px 1px 2px rgba(99,102,241,0.2);
          letter-spacing: 1px;
        }
        /* NEW: Logo styles */
        .brand-logo {
          max-width: 300px;
          width: 100%;
          height: auto;
          margin: 10px auto 20px auto;
          display: block;
        }
        /* NEW: Horizontal line styling */
        .divider-line {
          border: none;
          height: 2px;
          background: linear-gradient(to right, #3b82f6, #6366f1);
          margin: 20px auto;
          width: 80%;
          max-width: 300px;
        }
        h1 {
          font-size: 28px;
          font-weight: bold;
          margin-bottom: 10px;
          color: #111;
        }
        h2 {
          font-size: 20px;
          margin-top: 20px;
          color: #333;
        }
        #personal-message {
          font-size: 20px;
          margin: 20px 0;
          color: #3b82f6;
          font-weight: bold;
        }
        /* NEW: AI Message styling */
        .ai-message-container {
          background: linear-gradient(135deg, #f8f9ff, #e0e7ff);
          padding: 20px;
          border-radius: 12px;
          margin: 20px 0;
          border-left: 4px solid #3b82f6;
          text-align: left;
        }
        .ai-message-header {
          display: flex;
          align-items: center;
          gap: 10px;
          margin-bottom: 12px;
        }
        .ai-message-header h4 {
          margin: 0;
          color: #3b82f6;
          font-size: 16px;
        }
        .ai-message-text {
          font-style: italic;
          color: #555;
          font-size: 16px;
          line-height: 1.4;
          margin: 0;
        }
        #salonStylist {
          font-size: 18px;
          margin-top: 5px;
          color: #666;
          white-space: pre-line;
        }
        #caption {
          margin: 20px auto;
          font-size: 16px;
          color: #333;
          font-family: 'Courier New', Courier, monospace;
          padding: 15px;
          background: #f5f5f5;
          border-radius: 8px;
          word-wrap: break-word;
          text-align: center !important;
          width: 100%;
          max-width: 100%;
          box-sizing: border-box;
        }
        .media-grid {
          display: flex;
          flex-wrap: wrap;
          justify-content: center !important;
          gap: 15px;
          margin: 20px auto !important;
          width: 100%;
          padding: 0 10px;
          box-sizing: border-box;
        }
        .media-container {
          position: relative;
          width: 150px;
          height: 150px;
          margin: 0 auto 20px;
          overflow: hidden;
          border-radius: 10px;
          box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .media-item {
          width: 100%;
          height: 100%;
          object-fit: cover;
          border-radius: 10px;
          display: block;
        }
        .watermark {
          position: absolute;
          left: 8px;
          bottom: 8px;
          background-color: rgba(0, 0, 0, 0.6);
          color: white;
          padding: 3px 8px;
          border-radius: 4px;
          font-size: 12px;
          pointer-events: none;
          max-width: 90%;
          overflow: hidden;
          text-overflow: ellipsis;
          white-space: nowrap;
        }
        .media-actions {
          margin-top: 5px;
          text-align: center;
          width: 100%;
        }
        .save-button {
          background: #3b82f6;
          color: white;
          border: none;
          border-radius: 15px;
          padding: 6px 12px;
          font-size: 12px;
          cursor: pointer;
          margin: 5px 0;
          width: 100%;
          font-weight: bold;
        }
        .save-button:hover {
          background: #1e40af;
        }

        /* NEW: Before/After photo indicator styles */
        .photo-indicator {
          text-align: center;
          margin-top: 8px;
          font-size: 13px;
          font-weight: 600;
          padding: 4px 8px;
          border-radius: 12px;
          display: inline-block;
          min-width: 60px;
        }
        .photo-indicator.before {
          background: linear-gradient(135deg, #4CAF50, #45a049);
          color: white;
        }
        .photo-indicator.after {
          background: linear-gradient(135deg, #2196F3, #1976d2);
          color: white;
        }
        .photo-indicator.none {
          background: #f0f0f0;
          color: #666;
        }

        .button {
          display: block !important;
          margin: 15px auto !important;
          padding: 14px 24px;
          background: black;
          color: white;
          border: none;
          border-radius: 30px;
          font-size: 18px;
          cursor: pointer;
          font-weight: bold;
          transition: all 0.2s;
          width: auto;
          max-width: 90%;
          text-align: center;
        }
        .button:hover {
          background: #333;
          box-shadow: 0 3px 8px rgba(0,0,0,0.15);
        }
        .button:active {
          opacity: 0.8;
          transform: scale(0.98);
        }
        .social-buttons {
          display: flex;
          justify-content: center !important;
          gap: 12px;
          margin: 25px auto !important;
          width: 100%;
          flex-wrap: nowrap;
          max-width: 240px;
        }
        .icon-button {
          display: flex;
          flex-direction: column;
          align-items: center;
          background: none;
          border: none;
          cursor: pointer;
          flex: 1;
          min-width: 0;
        }
        .icon-label {
          margin-top: 5px;
          font-size: 12px;
          color: #555;
          text-align: center;
          white-space: nowrap;
        }
        .social-icon {
          width: 50px;
          height: 50px;
          transition: all 0.3s ease;
          border-radius: 50%;
          flex-shrink: 0;
        }
        .social-icon:hover {
          transform: scale(1.15);
          box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.2);
        }
        .instruction {
          font-size: 14px;
          margin: 15px 0;
          color: #333;
          background-color: #f9f9f9;
          padding: 10px;
          border-radius: 8px;
          border-left: 3px solid #3b82f6;
        }
        .instruction strong {
          color: #3b82f6;
        }
        footer {
          margin-top: 30px;
          font-size: 12px;
          color: #aaa;
        }
        .toast {
          position: fixed;
          bottom: 20px;
          left: 50%;
          transform: translateX(-50%);
          background: rgba(0, 0, 0, 0.8);
          color: white;
          padding: 10px 20px;
          border-radius: 20px;
          font-size: 16px;
          display: none;
          z-index: 1000;
        }
        .loading {
          display: flex;
          justify-content: center;
          align-items: center;
          height: 200px;
          flex-direction: column;
        }
        .spinner {
          width: 40px;
          height: 40px;
          border: 4px solid #f3f3f3;
          border-top: 4px solid #3b82f6;
          border-radius: 50%;
          animation: spin 1s linear infinite;
          margin-bottom: 15px;
        }
        .download-all-container {
          background: rgba(59, 130, 246, 0.1);
          padding: 15px;
          border-radius: 10px;
          margin: 20px auto;
          border: 1px solid rgba(59, 130, 246, 0.3);
          text-align: center !important;
          width: 100%;
          max-width: 100%;
          box-sizing: border-box;
        }
        .modal {
          display: none;
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background-color: rgba(0, 0, 0, 0.7);
          z-index: 1000;
          overflow: auto;
        }
        .modal-content {
          position: relative;
          background-color: #fff;
          margin: 10% auto;
          padding: 20px;
          border-radius: 15px;
          width: 80%;
          max-width: 500px;
          text-align: center;
        }
        .close-modal {
          position: absolute;
          top: 10px;
          right: 15px;
          font-size: 24px;
          font-weight: bold;
          cursor: pointer;
        }
        .save-instructions {
          padding: 20px;
          text-align: left;
        }
        .save-instructions li {
          margin-bottom: 10px;
        }
        .save-instructions img {
          max-width: 100%;
          height: auto;
          margin: 10px 0;
          border-radius: 8px;
          border: 1px solid #eee;
        }
        .help-badge {
          display: inline-block;
          background: #3b82f6;
          color: white;
          width: 20px;
          height: 20px;
          border-radius: 50%;
          text-align: center;
          line-height: 20px;
          margin-left: 5px;
          font-size: 14px;
          cursor: pointer;
        }
        .image-modal {
          display: none;
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background-color: rgba(0, 0, 0, 0.9);
          z-index: 1001;
          overflow: hidden;
          text-align: center;
        }
        .image-modal-content {
          position: relative;
          margin: 10vh auto;
          width: 90%;
          max-width: 800px;
          max-height: 80vh;
        }
        .image-modal img {
          max-width: 100%;
          max-height: 70vh;
          object-fit: contain;
          border-radius: 8px;
        }
        .image-modal-close {
          position: fixed;
          top: 20px;
          right: 20px;
          color: white;
          font-size: 36px;
          font-weight: bold;
          cursor: pointer;
          background-color: #3b82f6;
          width: 50px;
          height: 50px;
          line-height: 50px;
          text-align: center;
          border-radius: 50%;
          z-index: 1002;
          box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }
        .image-modal-close:hover {
          background-color: #1e40af;
          transform: scale(1.1);
        }
        .save-instruction-overlay {
          position: absolute;
          bottom: 20px;
          left: 0;
          width: 100%;
          color: white;
          background-color: rgba(0, 0, 0, 0.6);
          padding: 10px 0;
          font-size: 16px;
          border-radius: 0 0 8px 8px;
        }
        .step {
          margin: 20px 0;
          padding: 15px;
          background: #f9f9f9;
          border-radius: 10px;
          text-align: left;
        }
        .step-number {
          display: inline-block;
          width: 25px;
          height: 25px;
          background: #3b82f6;
          color: #fff;
          text-align: center;
          line-height: 25px;
          border-radius: 50%;
          margin-right: 10px;
        }
        .step-title {
          display: inline;
          font-weight: bold;
          font-size: 18px;
        }
        .step-content {
          margin-top: 10px;
          margin-left: 35px;
          display: flex;
          flex-direction: column;
          align-items: center;
          text-align: center;
        }
        .step-content p {
          text-align: center !important;
          width: 100%;
          margin: 10px 0;
        }
        .save-button.saved {
          background: #4caf50;
        }
        .google-review-button {
          background: #4285F4;
          border: none;
          border-radius: 30px;
          padding: 16px 24px;
          display: flex !important;
          justify-content: center;
          align-items: center;
          min-width: 220px;
          max-width: 90%;
          cursor: pointer;
          transition: background-color 0.3s ease;
          margin: 15px auto !important;
          gap: 15px;
          color: white;
          font-weight: bold;
          font-size: 16px;
          text-align: center;
          box-sizing: border-box;
        }
        .google-review-button:hover {
          background-color: #357ae8;
        }
        .google-icon {
          width: 36px !important;
          height: 36px !important;
          flex-shrink: 0;
          display: inline-block;
        }
        .save-button.saving {
          background: #ffc107;
          cursor: not-allowed;
        }
        .save-button.error {
          background: #f44336;
        }

        /* Progress Indicator Styles */
        .progress-container {
          margin: 20px 0 30px 0;
          text-align: center;
        }

        .progress-steps {
          display: flex;
          justify-content: center;
          align-items: center;
          margin-bottom: 10px;
          flex-wrap: nowrap;
          gap: 15px;
          max-width: 100%;
        }

        .progress-step {
          display: flex;
          flex-direction: column;
          align-items: center;
          opacity: 0.5;
          transition: all 0.3s ease;
          flex-shrink: 0;
          min-width: 60px;
        }

        .progress-step.active {
          opacity: 1;
          transform: scale(1.1);
        }

        .progress-step.completed {
          opacity: 0.8;
        }

        .step-circle {
          width: 40px;
          height: 40px;
          border-radius: 50%;
          background: #ddd;
          display: flex;
          align-items: center;
          justify-content: center;
          font-weight: bold;
          margin-bottom: 5px;
          transition: all 0.3s ease;
          font-size: 14px;
        }

        .progress-step.active .step-circle {
          background: linear-gradient(135deg, #3b82f6, #6366f1);
          color: white;
        }

        .progress-step.completed .step-circle {
          background: #4CAF50;
          color: white;
        }

        .progress-line {
          width: 40px;
          height: 2px;
          background: #ddd;
          margin: 0 5px;
          flex-shrink: 0;
        }

        .progress-subtitle {
          color: #666;
          font-size: 14px;
          margin: 0;
        }

        /* Save Your New Style Section */
        .save-your-style-section {
          margin: 30px 0;
          padding: 25px;
          background: linear-gradient(135deg, rgba(59,130,246,0.05), rgba(99,102,241,0.05));
          border-radius: 16px;
          border: 1px solid rgba(59,130,246,0.15);
        }

        .save-your-style-section h3 {
          text-align: center;
          color: #333;
          margin-bottom: 20px;
          font-size: 22px;
        }

        /* Smart Actions Styles */
        .smart-actions-container {
          margin: 30px 0;
          padding: 25px;
          background: linear-gradient(135deg, rgba(59,130,246,0.05), rgba(99,102,241,0.05));
          border-radius: 16px;
          border: 1px solid rgba(59,130,246,0.15);
        }

        .smart-actions-header {
          text-align: center;
          margin-bottom: 25px;
        }

        .smart-actions-header h3 {
          color: #333;
          margin-bottom: 10px;
          font-size: 22px;
          display: flex;
          align-items: center;
          justify-content: center;
          gap: 10px;
        }

        .smart-actions-header .social-icon-header {
          width: 32px;
          height: 32px;
        }

        .smart-action-grid {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
          gap: 20px;
          margin-bottom: 25px;
        }

        .smart-action-card {
          background: white;
          padding: 20px;
          border-radius: 12px;
          text-align: center;
          box-shadow: 0 4px 12px rgba(0,0,0,0.08);
          transition: all 0.3s ease;
          border: 2px solid transparent;
        }

        .smart-action-card:hover {
          transform: translateY(-2px);
          box-shadow: 0 8px 20px rgba(0,0,0,0.12);
        }

        .instagram-card:hover {
          border-color: #E4405F;
        }

        .facebook-card:hover {
          border-color: #1877F2;
        }

        .tiktok-card:hover {
          border-color: #000000;
        }

        .review-card:hover {
          border-color: #4285F4;
        }

        .action-icon {
          width: 48px;
          height: 48px;
          margin: 0 auto 15px;
          border-radius: 50%;
          display: flex;
          align-items: center;
          justify-content: center;
          background: #f8f9fa;
        }

        .action-icon img {
          width: 36px;
          height: 36px;
          border-radius: 50%;
        }

        .smart-action-card h4 {
          margin: 10px 0;
          color: #333;
          font-size: 18px;
        }

        .smart-action-card p {
          color: #666;
          font-size: 14px;
          margin-bottom: 15px;
          line-height: 1.4;
        }

        .smart-action-btn {
          width: 100%;
          padding: 12px 20px;
          border: none;
          border-radius: 25px;
          font-weight: 600;
          cursor: pointer;
          transition: all 0.2s ease;
          color: white;
        }

        .instagram-btn {
          background: linear-gradient(135deg, #E4405F, #C13584);
        }

        .facebook-btn {
          background: linear-gradient(135deg, #1877F2, #42A5F5);
        }

        .tiktok-btn {
          background: linear-gradient(135deg, #000000, #333333);
        }

        .review-btn {
          background: linear-gradient(135deg, #4285F4, #357ae8);
        }

        .smart-action-btn:hover {
          transform: scale(1.02);
          box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .smart-action-btn:active {
          transform: scale(0.98);
        }

        /* Products Section Styles */
        .products-section {
          margin: 25px 0;
        }

        .products-grid {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
          gap: 20px;
          margin: 20px 0;
          padding: 0 10px;
        }

        .product-card {
          background: #ffffff;
          border-radius: 12px;
          padding: 16px;
          box-shadow: 0 4px 8px rgba(0,0,0,0.1);
          transition: transform 0.2s ease, box-shadow 0.2s ease;
          border: 1px solid #f0f0f0;
        }

        .product-card:hover {
          transform: translateY(-2px);
          box-shadow: 0 6px 16px rgba(0,0,0,0.15);
        }

        .product-header {
          display: flex;
          align-items: center;
          margin-bottom: 12px;
        }

        .product-image {
          width: 60px;
          height: 60px;
          border-radius: 8px;
          background: linear-gradient(135deg, #3b82f6, #6366f1);
          display: flex;
          align-items: center;
          justify-content: center;
          color: white;
          font-weight: bold;
          font-size: 24px;
          margin-right: 12px;
          flex-shrink: 0;
          object-fit: cover;
        }

        .product-image img {
          width: 100%;
          height: 100%;
          border-radius: 8px;
          object-fit: cover;
        }

        .product-image.no-image {
          background: #f0f0f0;
          color: #999;
          font-size: 20px;
        }

        .product-info {
          flex: 1;
        }

        .product-brand {
          font-size: 12px;
          color: #3b82f6;
          font-weight: 600;
          text-transform: uppercase;
          letter-spacing: 0.5px;
        }

        .product-name {
          font-size: 16px;
          font-weight: bold;
          color: #333;
          margin: 4px 0;
        }

        .product-category {
          font-size: 12px;
          color: #666;
          background: #f8f9fa;
          padding: 2px 8px;
          border-radius: 12px;
          display: inline-block;
        }

        .product-description {
          font-size: 14px;
          color: #555;
          margin: 12px 0;
          line-height: 1.4;
        }

        .product-button {
          background: linear-gradient(135deg, #3b82f6, #6366f1) !important;
          color: white !important;
          border: none;
          border-radius: 25px;
          padding: 12px 20px;
          font-size: 14px;
          font-weight: 600;
          cursor: pointer;
          width: 100%;
          transition: all 0.2s ease;
          text-decoration: none !important;
          display: inline-block;
          text-align: center;
          box-sizing: border-box;
        }

        .product-button:hover {
          background: linear-gradient(135deg, #1e40af, #4f46e5) !important;
          transform: scale(1.02);
          text-decoration: none !important;
          color: white !important;
        }

        .product-button:visited {
          color: white !important;
          text-decoration: none !important;
        }

        .product-button:active {
          transform: scale(0.98);
        }

        .product-button:focus {
          outline: 2px solid #3b82f6;
          outline-offset: 2px;
        }

        .product-button-disabled {
          background: linear-gradient(135deg, #999, #777) !important;
          color: white !important;
          cursor: not-allowed !important;
          opacity: 0.7;
        }

        .product-button-disabled:hover {
          background: linear-gradient(135deg, #999, #777) !important;
          transform: none !important;
          text-decoration: none !important;
        }

        .products-intro {
          text-align: center;
          margin: 15px 0;
          padding: 15px;
          background: linear-gradient(135deg, rgba(255,153,0,0.1), rgba(255,193,7,0.1));
          border-radius: 12px;
          border: 1px solid rgba(255,153,0,0.2);
          grid-column: 1 / -1;
          display: flex;
          align-items: center;
          justify-content: center;
          gap: 10px;
        }

        .products-intro .amazon-icon {
          width: 24px;
          height: 24px;
          flex-shrink: 0;
        }

        .products-intro h3 {
          color: #ff9900;
          margin: 0 0 4px 0;
          font-size: 18px;
        }

        .products-intro p {
          color: #555;
          margin: 0;
          font-size: 14px;
        }

        .products-intro-content {
          flex: 1;
        }

        /* Products step number with image */
        .step-number.products-icon {
          background: linear-gradient(135deg, #3b82f6, #6366f1);
          width: 30px;
          height: 30px;
          display: inline-flex;
          align-items: center;
          justify-content: center;
          border-radius: 50%;
          margin-right: 10px;
        }

        .step-number.products-icon img {
          width: 18px;
          height: 18px;
          filter: brightness(0) invert(1); /* Make icon white */
        }

        /* NEW: Social instruction styling */
        .social-instruction {
          background: linear-gradient(135deg, rgba(0, 150, 136, 0.1), rgba(76, 175, 80, 0.1));
          border: 1px solid rgba(0, 150, 136, 0.2);
          border-radius: 12px;
          padding: 16px;
          margin: 15px 0;
          text-align: left;
        }

        .social-instruction-header {
          display: flex;
          align-items: center;
          gap: 10px;
          margin-bottom: 10px;
        }

        .social-instruction h4 {
          margin: 0;
          color: #00695C;
          font-size: 16px;
        }

        .social-instruction p {
          margin: 0;
          color: #555;
          font-size: 14px;
          line-height: 1.4;
        }

        /* NEW: Clipboard success styling */
        .clipboard-success {
          background: linear-gradient(135deg, rgba(76, 175, 80, 0.1), rgba(129, 199, 132, 0.1));
          border: 1px solid rgba(76, 175, 80, 0.3);
          border-radius: 12px;
          padding: 16px;
          margin: 15px 0;
          text-align: center;
        }

        .clipboard-success h4 {
          margin: 0 0 8px 0;
          color: #2E7D32;
          font-size: 16px;
        }

        .clipboard-success p {
          margin: 0;
          color: #388E3C;
          font-size: 14px;
        }

        @keyframes spin {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
        }
        @keyframes bounce {
          0%   { transform: scale(1); }
          30%  { transform: scale(0.85); }
          60%  { transform: scale(1.2); }
          100% { transform: scale(1); }
        }

        @media screen and (max-width: 768px) {
          .brand-logo {
            max-width: 250px;
          }
          .step-content {
            margin-left: 10px;
            padding: 0 10px;
          }
          .download-all-container,
          #caption {
            margin-left: 0;
            margin-right: 0;
            width: calc(100% - 20px);
          }
          .social-buttons {
            gap: 8px;
            max-width: 200px;
          }
          .social-icon {
            width: 45px;
            height: 45px;
          }
          .icon-label {
            font-size: 11px;
          }
          .google-review-button {
            min-width: 200px;
            font-size: 15px;
            padding: 14px 20px;
          }
          .google-icon {
            width: 32px !important;
            height: 32px !important;
          }
          .instruction {
            font-size: 16px;
            padding: 15px;
            margin: 15px 0;
          }
          .step {
            padding: 20px 15px;
          }
          .save-button {
            padding: 10px 15px;
            font-size: 14px;
          }
          .modal-content {
            margin: 5% auto;
            width: 90%;
            padding: 15px;
          }
          .image-modal-content {
            margin: 15vh auto;
          }
          .products-grid {
            grid-template-columns: 1fr;
            gap: 15px;
            padding: 0 5px;
          }
          .product-card {
            padding: 14px;
          }
          .product-image {
            width: 50px;
            height: 50px;
            font-size: 20px;
          }
          .product-button {
            font-size: 13px;
            padding: 10px 16px;
          }
          .smart-action-grid {
            grid-template-columns: 1fr;
            gap: 15px;
          }
          .smart-actions-container {
            padding: 20px 15px;
          }
          .smart-actions-header .social-icon-header {
            width: 28px;
            height: 28px;
          }
          .products-intro {
            flex-direction: column;
            gap: 8px;
          }
          .progress-line {
            width: 30px;
          }
          .step-circle {
            width: 35px;
            height: 35px;
            font-size: 12px;
          }
          .progress-step {
            min-width: 50px;
          }
          .progress-steps {
            gap: 8px;
          }
          .ai-message-container {
            padding: 16px;
          }
          .photo-indicator {
            font-size: 12px;
            padding: 3px 6px;
            min-width: 50px;
          }
        }

        @supports (-webkit-touch-callout: none) {
          .step-content {
            -webkit-text-align-last: center;
          }
          .button,
          .google-review-button {
            -webkit-appearance: none;
            -webkit-tap-highlight-color: transparent;
          }
        }

        @media screen and (-webkit-min-device-pixel-ratio: 1) {
          .google-icon {
            image-rendering: -webkit-optimize-contrast;
          }
        }
    </style>
    <script type="text/javascript">
        (function(b,r,a,n,c,h,_,s,d,k){if(!b[n]||!b[n]._q){for(;s<_.length;)c(h,_[s++]);d=r.createElement(a);d.async=1;d.src="https://cdn.branch.io/branch-latest.min.js";k=r.getElementsByTagName(a)[0];k.parentNode.insertBefore(d,k);b[n]=h}})(window,document,"script","branch",function(b,r){b[r]=function(){b._q.push([r,arguments])}},{_q:[],_v:1},"addListener applyCode autoAppIndex banner closeBanner closeJourney creditHistory credits data deepview deepviewCta first getCode init link logout redeem referrals removeListener sendSMS setBranchViewData setIdentity track validateCode trackCommerceEvent logEvent disableTracking".split(" "), 0);
        branch.init('key_live_jtEolBcoQrajD2oV180Klfbmqqbjhr6W');
    </script>
</head>
<body>
<div class="container">
    <!-- UPDATED: Replace text with logo image -->
    <img src="postmystyletitle.png" alt="PostMyStyle" class="brand-logo" onerror="this.onerror=null; this.src='data:image/svg+xml;utf8,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22300%22 height=%2280%22><text x=%2210%22 y=%2250%22 font-size=%2232%22 fill=%22%233b82f6%22 font-weight=%22bold%22>PostMyStyle</text></svg>'"/>

    <!-- UPDATED: Dynamic header with salon and stylist names -->
    <h1 id="dynamic-header">Share Your New Look!</h1>

    <!-- NEW: Replace logo with horizontal line -->
    <hr class="divider-line">

    <div id="loading" class="loading">
        <div class="spinner"></div>
        <p>Loading your style...</p>
    </div>

    <div id="content" style="display: none;">
        <div id="personal-message"></div>

        <!-- Progress Indicator -->
        <div class="progress-container">
            <div class="progress-steps">
                <div class="progress-step active" data-step="1">
                    <div class="step-circle">1</div>
                    <span>Save</span>
                </div>
                <div class="progress-line"></div>
                <div class="progress-step" data-step="2">
                    <div class="step-circle">2</div>
                    <span>Share</span>
                </div>
                <div class="progress-line"></div>
                <div class="progress-step" data-step="3">
                    <div class="step-circle">3</div>
                    <span>Review</span>
                </div>
            </div>
            <p class="progress-subtitle">Three simple steps to share your amazing transformation!</p>
        </div>

        <!-- Save Your New Style Section -->
        <div class="save-your-style-section">
            <h3>💾 Save Your New Style</h3>
            <div class="download-all-container">
                <button class="button" onclick="saveAllPhotos()">Save All Photos <span class="help-badge" onclick="showHelpModal(event)">?</span></button>
            </div>
            <div class="media-grid" id="mediaGrid"></div>
        </div>

        <!-- Smart Action Cards -->
        <div class="smart-actions-container">
            <div class="smart-actions-header">
                <h3>
                    <img src="social.png" alt="Share" class="social-icon-header" onerror="this.onerror=null; this.src='data:image/svg+xml;utf8,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%2232%22 height=%2232%22><rect width=%2232%22 height=%2232%22 rx=%2216%22 fill=%22%233b82f6%22/><text x=%2216%22 y=%2222%22 font-size=%2218%22 text-anchor=%22middle%22 fill=%22white%22>📱</text></svg>'"/>
                    Quick Share and Review
                </h3>
            </div>

            <div class="smart-action-grid">
                <!-- Instagram All-in-One -->
                <div class="smart-action-card instagram-card">
                    <div class="action-icon">
                        <img src="instagram.png" alt="Instagram" onerror="this.onerror=null; this.src='data:image/svg+xml;utf8,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%2236%22 height=%2236%22><rect width=%2236%22 height=%2236%22 rx=%2218%22 fill=%22%23E4405F%22/><text x=%2218%22 y=%2225%22 font-size=%2220%22 text-anchor=%22middle%22 fill=%22white%22>IG</text></svg>'"/>
                    </div>
                    <h4>Share to Instagram</h4>
                    <p>Save photos + Copy caption + Create your post</p>
                    <button class="smart-action-btn instagram-btn" onclick="doInstagramFlow()">
                        Ready to Share
                    </button>
                </div>

                <!-- Facebook All-in-One -->
                <div class="smart-action-card facebook-card">
                    <div class="action-icon">
                        <img src="facebook.png" alt="Facebook" onerror="this.onerror=null; this.src='data:image/svg+xml;utf8,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%2236%22 height=%2236%22><rect width=%2236%22 height=%2236%22 rx=%2218%22 fill=%22%231877F2%22/><text x=%2218%22 y=%2225%22 font-size=%2220%22 text-anchor=%22middle%22 fill=%22white%22>FB</text></svg>'"/>
                    </div>
                    <h4>Share to Facebook</h4>
                    <p>Save photos + Copy caption + Create your post</p>
                    <button class="smart-action-btn facebook-btn" onclick="doFacebookFlow()">
                        Ready to Share
                    </button>
                </div>

                <!-- TikTok All-in-One -->
                <div class="smart-action-card tiktok-card">
                    <div class="action-icon">
                        <img src="tiktok.png" alt="TikTok" onerror="this.onerror=null; this.src='data:image/svg+xml;utf8,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%2236%22 height=%2236%22><rect width=%2236%22 height=%2236%22 rx=%2218%22 fill=%22%23000000%22/><text x=%2218%22 y=%2225%22 font-size=%2216%22 text-anchor=%22middle%22 fill=%22white%22>TT</text></svg>'"/>
                    </div>
                    <h4>Share to TikTok</h4>
                    <p>Save photos + Copy caption + Create your post</p>
                    <button class="smart-action-btn tiktok-btn" onclick="doTikTokFlow()">
                        Ready to Share
                    </button>
                </div>

                <!-- Google Review -->
                <div class="smart-action-card review-card">
                    <div class="action-icon">
                        <img src="google.png" alt="Google" onerror="this.onerror=null; this.src='data:image/svg+xml;utf8,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%2236%22 height=%2236%22><rect width=%2236%22 height=%2236%22 rx=%2218%22 fill=%22%234285F4%22/><text x=%2218%22 y=%2225%22 font-size=%2220%22 text-anchor=%22middle%22 fill=%22white%22>G</text></svg>'"/>
                    </div>
                    <h4>Leave a Google Review</h4>
                    <p>Enjoyed your style? Let others know</p>
                    <button class="smart-action-btn review-btn" onclick="doReviewFlow()">
                        Leave a Review
                    </button>
                </div>
            </div>
        </div>

        <!-- Products Section -->
        <div id="productsSection" class="products-section" style="display: none;">
            <div class="step">
                <div class="step-number products-icon">
                    <img src="products.png" alt="Products" onerror="this.onerror=null; this.src='data:image/svg+xml;utf8,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%2218%22 height=%2218%22><rect width=%2218%22 height=%2218%22 fill=%22white%22/><text x=%229%22 y=%2214%22 font-size=%2212%22 text-anchor=%22middle%22 fill=%22black%22>💄</text></svg>'"/>
                </div>
                <div class="step-title">Products Used in Your Session</div>
                <div class="step-content">
                    <p>Get the same professional results at home with these products:</p>
                    <div id="productsGrid" class="products-grid"></div>
                </div>
            </div>
        </div>
    </div>

    <footer>Powered by PostMyStyle.ai</footer>
    <div id="toast" class="toast"></div>

    <div id="helpModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeHelpModal()">&times;</span>
            <h2>How to Save Photos</h2>
            <div class="save-instructions" id="saveInstructions"></div>
            <button class="button" onclick="closeHelpModal()">Got it!</button>
        </div>
    </div>

    <div id="imageModal" class="image-modal">
        <div class="image-modal-content">
            <span id="imageCloseButton" class="image-modal-close" onclick="closeImageModal()">&times;</span>
            <img id="modalImage" src="" alt="Full size image">
            <div class="save-instruction-overlay">Press and hold on image to save to your device</div>
        </div>
    </div>
</div>

<script>
    // Global variables
    let googleReviewUrl = null;
    let globalMediaSendId = null;
    let globalInstagramHandle = '';
    let globalFacebookHandle = '';
    let globalTikTokHandle = '';
    // NEW: Global AI message variables
    let globalAISMSMessage = '';
    let globalAISocialCaption = '';

    // NEW: Global before/after photo arrays
    let globalBeforePhotoIndices = [];
    let globalAfterPhotoIndices = [];

    const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
    const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
    const isAndroid = /Android/i.test(navigator.userAgent);

    const SUPABASE_URL = 'https://mffqaqvjylkotkgvytro.supabase.co';
    const SUPABASE_API_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1mZnFhcXZqeWxrb3RrZ3Z5dHJvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDYxMTI5MzYsImV4cCI6MjA2MTY4ODkzNn0.oUlS-JS1G9OHjwv89xZY_QRqwsoI-GE8c-ZE_U2TjDc';

    // Utility functions
    function showToast(message, duration = 2000) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.style.display = 'block';
      setTimeout(() => {
        toast.style.display = 'none';
      }, duration);
    }

    function getURLParameters() {
      const params = new URLSearchParams(window.location.search);
      const result = {};
      for (const [key, value] of params.entries()) {
        result[key] = value;
      }
      return result;
    }

    function getFirstName(fullName) {
      if (!fullName) return '';
      return fullName.split(' ')[0];
    }

    // NEW: Function to parse before/after photo indices - handles both arrays and strings
    function parsePhotoIndices(indicesData) {
      // Handle if it's already an array (from Branch structured data)
      if (Array.isArray(indicesData)) {
        return indicesData.filter(num => typeof num === 'number' && num >= 0);
      }

      // Handle if it's a string (from URL parameters)
      if (!indicesData || indicesData.trim() === '') {
        return [];
      }

      return indicesData.split(',').map(str => {
        const num = parseInt(str.trim());
        return isNaN(num) ? -1 : num;
      }).filter(num => num >= 0);
    }

    // NEW: Function to get photo indicator type
    function getPhotoIndicatorType(photoIndex) {
      if (globalBeforePhotoIndices.includes(photoIndex)) {
        return 'before';
      }
      if (globalAfterPhotoIndices.includes(photoIndex)) {
        return 'after';
      }
      return 'none';
    }

    // NEW: Function to create photo indicator element
    function createPhotoIndicator(photoIndex) {
      const indicatorType = getPhotoIndicatorType(photoIndex);
      const indicator = document.createElement('div');
      indicator.className = `photo-indicator ${indicatorType}`;

      switch (indicatorType) {
        case 'before':
          indicator.textContent = 'Before';
          break;
        case 'after':
          indicator.textContent = 'After';
          break;
        default:
          indicator.textContent = 'Photo';
          break;
      }

      return indicator;
    }

    // Progress tracking functions
    function updateProgress(stepNumber) {
      document.querySelectorAll('.progress-step').forEach((step, index) => {
        if (index < stepNumber) {
          step.classList.add('completed');
          step.classList.remove('active');
        } else if (index === stepNumber - 1) {
          step.classList.add('active');
          step.classList.remove('completed');
        } else {
          step.classList.remove('active', 'completed');
        }
      });
    }

    // FIXED: Create personalized social caption without duplication
    function createEnhancedSocialCaption() {
      let enhancedCaption = '';

      // The caption from React Native already includes AI social + original caption
      const originalCaption = document.getElementById('caption');
      if (originalCaption && originalCaption.textContent.trim() !== '') {
        enhancedCaption = originalCaption.textContent;
        console.log('🎯 Using pre-enhanced caption from app:', enhancedCaption);
      } else if (globalAISocialCaption && globalAISocialCaption.trim() !== '') {
        // Fallback: use AI social caption only if no pre-enhanced caption
        enhancedCaption = globalAISocialCaption;
        console.log('🎯 Using AI social caption only:', globalAISocialCaption);
      }

      // Add salon handle if available
      if (globalInstagramHandle && globalInstagramHandle.trim() !== '') {
        const handle = globalInstagramHandle.startsWith('@') ? globalInstagramHandle : `@${globalInstagramHandle}`;
        enhancedCaption += `\n\n✨ Styled by ${handle}`;
        console.log('🔗 Added salon handle:', handle);
      }

      console.log('🎯 Final enhanced caption:', enhancedCaption);
      return enhancedCaption;
    }

    // FIXED: Unified clipboard copying function that works on all platforms
    function copyToClipboard(text) {
      console.log('🔄 copyToClipboard called with text length:', text.length);
      console.log('🔄 Device: iOS =', isIOS, ', Android =', isAndroid);

      // Try modern Clipboard API first (works on all modern browsers when HTTPS)
      if (navigator.clipboard && navigator.clipboard.writeText) {
        console.log('✅ Using modern Clipboard API');
        navigator.clipboard.writeText(text).then(() => {
          console.log('✅ Modern clipboard copy successful');
          showClipboardSuccess();
        }).catch(err => {
          console.log('❌ Modern clipboard failed, trying fallback:', err);
          fallbackCopyToClipboard(text);
        });
      } else {
        console.log('⚠️ No modern Clipboard API, using fallback');
        fallbackCopyToClipboard(text);
      }
    }

    // Fallback clipboard method for older browsers
    function fallbackCopyToClipboard(text) {
      try {
        const textArea = document.createElement('textarea');
        textArea.value = text;
        textArea.style.position = 'fixed';
        textArea.style.left = '-999999px';
        textArea.style.top = '-999999px';
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();

        const copied = document.execCommand('copy');
        document.body.removeChild(textArea);

        if (copied) {
          console.log('✅ Fallback clipboard copy successful');
          showClipboardSuccess();
        } else {
          console.log('❌ Fallback clipboard copy failed');
          showClipboardFallback(text);
        }
      } catch (err) {
        console.error('❌ Fallback copy method error:', err);
        showClipboardFallback(text);
      }
    }

    // Show clipboard success message
    function showClipboardSuccess() {
      showToast('✅ Caption copied to clipboard!', 3000);

      // Also show a success indicator in the page
      showClipboardSuccessIndicator();
    }

    // Show clipboard success indicator in the page
    function showClipboardSuccessIndicator() {
      // Remove any existing indicators
      const existingIndicator = document.querySelector('.clipboard-success');
      if (existingIndicator) {
        existingIndicator.remove();
      }

      const indicator = document.createElement('div');
      indicator.className = 'clipboard-success';
      indicator.innerHTML = `
        <h4>✅ Caption Copied!</h4>
        <p>Your caption is now ready to paste in your social media app</p>
      `;

      // Insert after smart actions
      const smartActions = document.querySelector('.smart-actions-container');
      if (smartActions) {
        smartActions.insertAdjacentElement('afterend', indicator);

        // Remove after 8 seconds
        setTimeout(() => {
          if (indicator && indicator.parentNode) {
            indicator.remove();
          }
        }, 8000);
      }
    }

    // Show caption for manual copying when automatic copying fails
    function showClipboardFallback(text) {
      showToast('Tap the text below to copy your caption', 4000);

      // Remove any existing caption display
      const existingCaption = document.querySelector('.manual-caption-display');
      if (existingCaption) {
        existingCaption.remove();
      }

      const captionDisplay = document.createElement('div');
      captionDisplay.className = 'manual-caption-display social-instruction';
      captionDisplay.style.background = 'linear-gradient(135deg, rgba(59,130,246,0.1), rgba(99,102,241,0.1))';
      captionDisplay.style.borderColor = '#3b82f6';
      captionDisplay.style.marginTop = '15px';

      captionDisplay.innerHTML = `
        <div class="social-instruction-header">
          <span>📋</span>
          <h4>Your Caption (Tap to Select & Copy)</h4>
        </div>
        <div style="font-family: monospace; padding: 12px; background: white; border-radius: 8px; margin-top: 10px; user-select: all; -webkit-user-select: all; font-size: 14px; line-height: 1.4; border: 2px dashed #3b82f6;" onclick="selectAllText(this)">
          ${text}
        </div>
        <p style="margin-top: 8px; font-size: 12px; color: #666; text-align: center;">
          <strong>Tip:</strong> Tap the text above, then "Select All" and "Copy"
        </p>
      `;

      // Insert right after the smart actions container
      const smartActions = document.querySelector('.smart-actions-container');
      if (smartActions) {
        smartActions.insertAdjacentElement('afterend', captionDisplay);

        // Remove after 30 seconds
        setTimeout(() => {
          if (captionDisplay && captionDisplay.parentNode) {
            captionDisplay.remove();
          }
        }, 30000);
      }
    }

    // Helper function to select all text in an element
    function selectAllText(element) {
      if (document.selection) {
        const range = document.body.createTextRange();
        range.moveToElementText(element);
        range.select();
      } else if (window.getSelection) {
        const range = document.createRange();
        range.selectNode(element);
        window.getSelection().removeAllRanges();
        window.getSelection().addRange(range);
      }

      // Try to copy again after selection
      try {
        document.execCommand('copy');
        showToast('✅ Text copied!');
      } catch (err) {
        console.log('Copy after selection failed:', err);
      }
    }

    // FIXED: Enhanced smart action workflows with iOS-specific photo handling
    function doInstagramFlow() {
      updateProgress(2);
      showToast('Preparing your Instagram post...');

      // 1. Handle photos based on device type
      const mediaItems = document.querySelectorAll('.media-item');
      if (mediaItems.length > 0) {
        if (isIOS) {
          // For iOS: Show instruction for manual saving to Photos
          showToast('📸 Caption copied! Tap photos below to save them to your Photos app', 4000);
          console.log('📸 iOS: Instructing manual photo saving for Photos app');
        } else {
          // For non-iOS: Auto-download
          console.log('📸 Starting photo downloads for', mediaItems.length, 'photos');
          mediaItems.forEach((item, index) => {
            setTimeout(() => {
              const downloadUrl = item.getAttribute('data-watermarked-url') ||
                                 item.getAttribute('data-url') ||
                                 item.src;

              console.log(`📸 Downloading photo ${index + 1}:`, downloadUrl);
              downloadPhotoForSharing(downloadUrl, `PostMyStyle-${index + 1}.jpg`);
            }, index * 200);
          });
        }
      }

      // 2. Copy enhanced caption with AI content
      setTimeout(() => {
        const enhancedCaption = createEnhancedSocialCaption();
        copyToClipboard(enhancedCaption);
      }, 300); // Immediate for iOS

      // 3. Open social platform and track
      setTimeout(() => {
        const handle = globalInstagramHandle ?
          (globalInstagramHandle.startsWith('@') ? globalInstagramHandle : `@${globalInstagramHandle}`) : '';

        if (isIOS) {
          if (handle) {
            showToast(`📋 Caption ready! Save photos to Photos, then tag ${handle} in Instagram!`, 5000);
          } else {
            showToast('📋 Caption ready! Save photos to Photos, then share in Instagram!', 4000);
          }
        } else {
          if (handle) {
            showToast(`📸 Photos saved, caption copied! Don't forget to tag ${handle}`, 4000);
          } else {
            showToast('📸 Photos saved and caption copied! Ready to share!', 3000);
          }
        }

        // Open Instagram app or website
        openSocialPlatform('instagram');
        trackSocialClick('instagram', getMediaSendId());
      }, isIOS ? 800 : 1200);
    }

    function doFacebookFlow() {
      updateProgress(2);
      showToast('Preparing your Facebook post...');

      // 1. Handle photos based on device type
      const mediaItems = document.querySelectorAll('.media-item');
      if (mediaItems.length > 0) {
        if (isIOS) {
          // For iOS: Show instruction for manual saving to Photos
          showToast('📸 Caption copied! Tap photos below to save them to your Photos app', 4000);
          console.log('📸 iOS: Instructing manual photo saving for Photos app');
        } else {
          // For non-iOS: Auto-download
          console.log('📸 Starting photo downloads for Facebook:', mediaItems.length, 'photos');
          mediaItems.forEach((item, index) => {
            setTimeout(() => {
              const downloadUrl = item.getAttribute('data-watermarked-url') ||
                                 item.getAttribute('data-url') ||
                                 item.src;
              downloadPhotoForSharing(downloadUrl, `PostMyStyle-${index + 1}.jpg`);
            }, index * 200);
          });
        }
      }

      // 2. Copy caption
      setTimeout(() => {
        const enhancedCaption = createEnhancedSocialCaption();
        copyToClipboard(enhancedCaption);
      }, 300);

      // 3. Open Facebook and track
      setTimeout(() => {
        const handle = globalFacebookHandle ?
          (globalFacebookHandle.startsWith('@') ? globalFacebookHandle : `@${globalFacebookHandle}`) : '';

        if (isIOS) {
          if (handle) {
            showToast(`📋 Caption ready! Save photos to Photos, then tag ${handle} in Facebook!`, 5000);
          } else {
            showToast('📋 Caption ready! Save photos to Photos, then share in Facebook!', 4000);
          }
        } else {
          if (handle) {
            showToast(`📸 Photos saved, caption copied! Don't forget to tag ${handle}`, 4000);
          } else {
            showToast('📸 Photos saved and caption copied! Ready to share!', 3000);
          }
        }

        openSocialPlatform('facebook');
        trackSocialClick('facebook', getMediaSendId());
      }, isIOS ? 800 : 1200);
    }

    function doTikTokFlow() {
      updateProgress(2);
      showToast('Preparing your TikTok post...');

      // 1. Handle photos based on device type
      const mediaItems = document.querySelectorAll('.media-item');
      if (mediaItems.length > 0) {
        if (isIOS) {
          // For iOS: Show instruction for manual saving to Photos
          showToast('📸 Caption copied! Tap photos below to save them to your Photos app', 4000);
          console.log('📸 iOS: Instructing manual photo saving for Photos app');
        } else {
          // For non-iOS: Auto-download
          console.log('📸 Starting photo downloads for TikTok:', mediaItems.length, 'photos');
          mediaItems.forEach((item, index) => {
            setTimeout(() => {
              const downloadUrl = item.getAttribute('data-watermarked-url') ||
                                 item.getAttribute('data-url') ||
                                 item.src;
              downloadPhotoForSharing(downloadUrl, `PostMyStyle-${index + 1}.jpg`);
            }, index * 200);
          });
        }
      }

      // 2. Copy caption
      setTimeout(() => {
        const enhancedCaption = createEnhancedSocialCaption();
        copyToClipboard(enhancedCaption);
      }, 300);

      // 3. Open TikTok and track
      setTimeout(() => {
        const handle = globalTikTokHandle ?
          (globalTikTokHandle.startsWith('@') ? globalTikTokHandle : `@${globalTikTokHandle}`) : '';

        if (isIOS) {
          if (handle) {
            showToast(`📋 Caption ready! Save photos to Photos, then tag ${handle} in TikTok!`, 5000);
          } else {
            showToast('📋 Caption ready! Save photos to Photos, then share in TikTok!', 4000);
          }
        } else {
          if (handle) {
            showToast(`📸 Photos saved, caption copied! Don't forget to tag ${handle}`, 4000);
          } else {
            showToast('📸 Photos saved and caption copied! Ready to share!', 3000);
          }
        }

        openSocialPlatform('tiktok');
        trackSocialClick('tiktok', getMediaSendId());
      }, isIOS ? 800 : 1200);
    }

    function doReviewFlow() {
      updateProgress(3);

      // Open Google review and highlight products section
      if (googleReviewUrl) {
        showToast('Thank you! Opening review page...');
        setTimeout(() => {
          window.open(googleReviewUrl, '_blank');

          // Highlight products section
          const productsSection = document.getElementById('productsSection');
          if (productsSection) {
            productsSection.scrollIntoView({ behavior: 'smooth' });
            productsSection.style.transform = 'scale(1.02)';
            productsSection.style.transition = 'transform 0.3s ease';
            setTimeout(() => {
              productsSection.style.transform = 'scale(1)';
            }, 1000);
          }

          reportShareToSupabase('google_review_clicks', getMediaSendId());
        }, 500);
      } else {
        // If no Google review, just highlight products
        const productsSection = document.getElementById('productsSection');
        if (productsSection) {
          productsSection.scrollIntoView({ behavior: 'smooth' });
          showToast('Check out the products used in your transformation!');
        }
      }
    }

    // REQUIRED: iOS Photos app saving using Web Share API
    async function saveToIOSPhotos(url, filename) {
      try {
        // Fetch the image
        const response = await fetch(url);
        const blob = await response.blob();

        // Create File object
        const file = new File([blob], filename, { type: 'image/jpeg' });

        // Check if Web Share API supports files
        if (navigator.canShare && navigator.canShare({ files: [file] })) {
          // This opens iOS share sheet with "Save to Photos" option
          await navigator.share({
            files: [file],
            title: 'Save to Photos',
            text: 'PostMyStyle photo'
          });
          return true;
        } else {
          throw new Error('Web Share API not supported');
        }
      } catch (error) {
        console.error('Web Share failed:', error);
        return false;
      }
    }

    // iOS Photos saving with modal fallback
    async function saveImageToPhotos(url, filename, index) {
      if (isIOS) {
        // Try Web Share API first
        const webShareWorked = await saveToIOSPhotos(url, filename);
        if (webShareWorked) {
          showToast(`Photo ${index} - tap "Save to Photos" in the share sheet`, 3000);
          return;
        }

        // Fallback: show modal for manual Photos saving
        showImageModal(url);
        showToast('Press and hold image → "Add to Photos"', 3000);
      } else {
        // Non-iOS: regular download
        directDownload(url, filename);
      }
    }

    // Simple download for non-iOS devices
    function directDownload(url, filename) {
      try {
        fetch(url)
          .then(response => response.blob())
          .then(blob => {
            const blobUrl = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = blobUrl;
            link.download = filename;
            link.style.display = 'none';
            document.body.appendChild(link);
            link.click();
            setTimeout(() => {
              URL.revokeObjectURL(blobUrl);
              document.body.removeChild(link);
            }, 100);
          });
      } catch (err) {
        console.error('Download failed:', err);
      }
    }

    // Modal functions
    function showHelpModal(event) {
      if (event) {
        event.stopPropagation();
      }
      const modal = document.getElementById('helpModal');
      const instructions = document.getElementById('saveInstructions');

      if (isIOS) {
        instructions.innerHTML = `
          <p><strong>Automatic (Smart Share buttons):</strong></p>
          <ol>
            <li>Use Instagram/Facebook/TikTok buttons above</li>
            <li>Caption copies and photos download automatically</li>
            <li>Photos may save to Downloads/Files folder</li>
          </ol>
          <p><strong>Manual (for Photos app):</strong></p>
          <ol>
            <li>Tap any photo below to view full-screen</li>
            <li>Press and hold on the image</li>
            <li>Tap "Add to Photos"</li>
            <li>Tap blue X to return</li>
          </ol>
          <p><strong>💡 Try the automatic method first - it's much faster!</strong></p>
        `;
      } else if (isAndroid) {
        instructions.innerHTML = `
          <p><strong>Automatic downloads work great on Android!</strong></p>
          <ol>
            <li><strong>Use the Instagram/Facebook/TikTok buttons above</strong> - they handle everything automatically!</li>
            <li>Caption copies to clipboard and photos download to your Downloads folder</li>
            <li><strong>Or manually:</strong> Tap "Save Photo" under each image</li>
            <li>Photos appear in your Gallery or Downloads folder</li>
          </ol>
          <p><strong>✅ Android users get the best automatic experience!</strong></p>
        `;
      } else {
        instructions.innerHTML = `
          <p><strong>Desktop automatic downloads work perfectly!</strong></p>
          <ol>
            <li><strong>Use the Instagram/Facebook/TikTok buttons above</strong> - everything is automatic!</li>
            <li>Caption copies to clipboard and photos download to your Downloads folder</li>
            <li><strong>Or manually:</strong> Click "Save Photo" under each image</li>
            <li>All photos save to your default Downloads location</li>
          </ol>
        `;
      }
      modal.style.display = 'block';
    }

    function closeHelpModal() {
      document.getElementById('helpModal').style.display = 'none';
    }

    function showImageModal(url) {
      const modal = document.getElementById('imageModal');
      const modalImg = document.getElementById('modalImage');
      modalImg.src = url;
      modal.style.display = 'block';
      const closeButton = document.getElementById('imageCloseButton');
      closeButton.style.display = 'block';
      if (isIOS) {
        showToast('Press and hold on the image to save it');
      }
    }

    function closeImageModal() {
      document.getElementById('imageModal').style.display = 'none';
    }

    // Legacy function for backwards compatibility
    function copyHashtags() {
      const originalCaption = document.getElementById('caption').textContent;
      copyToClipboard(originalCaption);
    }

    // Enhanced product image validation
    function isValidImageUrl(url) {
      if (!url || typeof url !== 'string') return false;
      return url.trim() !== '' &&
             (url.startsWith('http://') || url.startsWith('https://')) &&
             /\.(jpg|jpeg|png|gif|webp)$/i.test(url);
    }

    // Enhanced product functions supporting both Branch structured format and URL parameters
    function processProductData(data) {
      console.log('🔍 PROCESSING PRODUCTS - DUAL FORMAT SUPPORT 🔍');
      console.log('Raw data received:', data);

      let productCount = 0;
      let products = [];

      // METHOD 1: Check for structured products array (from Branch)
      if (data.products && Array.isArray(data.products)) {
        console.log('✅ Found structured products array:', data.products);
        products = data.products;
        productCount = products.length;
        console.log(`📊 Product count from array: ${productCount}`);
      }
      // METHOD 2: Check for URL parameter format (fallback)
      else {
        const urlProductCount = parseInt(data.productCount || '0');
        console.log(`📊 Checking URL parameter format, count: ${urlProductCount}`);

        if (urlProductCount > 0) {
          // Convert URL parameters to structured format
          for (let i = 1; i <= urlProductCount; i++) {
            const product = {
              id: data[`product${i}_id`],
              brand: data[`product${i}_brand`],
              name: data[`product${i}_name`],
              category: data[`product${i}_category`],
              affiliateUrl: data[`product${i}_affiliate_url`],
              notes: data[`product${i}_notes`],
              image: data[`product${i}_image`] // Fixed: Use correct field name
            };

            console.log(`URL Product ${i}:`, product);

            if (product.brand && product.name) {
              products.push(product);
            }
          }
          productCount = products.length;
        }
      }

      console.log(`🎯 Final product count: ${productCount}`);
      console.log(`🎯 Final products array:`, products);

      const productsSection = document.getElementById('productsSection');
      const productsGrid = document.getElementById('productsGrid');

      if (productCount === 0) {
        console.log('❌ No valid products found');
        productsSection.style.display = 'none';
        return;
      }

      // Clear and setup
      productsGrid.innerHTML = '';

      const intro = document.createElement('div');
      intro.className = 'products-intro';
      intro.innerHTML = `
        <img src="amazon.png" alt="Shop" class="amazon-icon" onerror="this.onerror=null; this.src='data:image/svg+xml;utf8,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%2224%22 height=%2224%22><rect width=%2224%22 height=%2224%22 rx=%2212%22 fill=%22%23FF9900%22/><text x=%2212%22 y=%2216%22 font-size=%2214%22 text-anchor=%22middle%22 fill=%22white%22>🛒</text></svg>'"/>
        <div class="products-intro-content">
          <h3>Recreate Your Look at Home</h3>
          <p>These are the exact professional products your stylist used:</p>
        </div>
      `;
      productsGrid.appendChild(intro);

      // Process products from unified array
      products.forEach((product, index) => {
        console.log(`\n--- 🛍️ PROCESSING PRODUCT ${index + 1} ---`);
        console.log('Product object:', product);

        const { brand, name, category, affiliateUrl, notes, image } = product;

        console.log(`Brand: "${brand}"`);
        console.log(`Name: "${name}"`);
        console.log(`Affiliate URL: "${affiliateUrl}"`);
        console.log(`Image URL: "${image}"`);

        if (brand && name) {
          const card = document.createElement('div');
          card.className = 'product-card';

          // Handle product image with correct field name
          let productImageHtml = '';
          if (isValidImageUrl(image)) {
            productImageHtml = `<img src="${image}" alt="${name}" />`;
            console.log('✅ Using product image:', image);
          } else {
            // Use NO IMAGE AVAILABLE placeholder
            productImageHtml = `<img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA2MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjYwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjBGMEYwIi8+CjxwYXRoIGQ9Ik0yMCAyNkgyNlYzMkgyMFYyNloiIGZpbGw9IiM5OTk5OTkiLz4KPHBhdGggZD0iTTMwIDIySDM2VjI4SDMwVjIyWiIgZmlsbD0iIzk5OTk5OSIvPgo8dGV4dCB4PSIzMCIgeT0iNDUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSI4IiBmaWxsPSIjOTk5OTk5IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIj5OTyBJTUFHRTwvdGV4dD4KPHR4dCB4PSIzMCIgeT0iNTQiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSI2IiBmaWxsPSIjOTk5OTk5IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIj5BVkFJTEFCTEU8L3RleHQ+Cjwvc3ZnPgo=" alt="No image available" style="opacity: 0.7;" />`;
            console.log('❌ Using NO IMAGE placeholder');
          }

          // Check URL validity
          const hasValidUrl = affiliateUrl &&
                             typeof affiliateUrl === 'string' &&
                             affiliateUrl.trim() !== '' &&
                             (affiliateUrl.includes('http://') || affiliateUrl.includes('https://'));

          console.log(`🔗 Has valid URL: ${hasValidUrl}`);

          let buttonHtml;
          if (hasValidUrl) {
            buttonHtml = `
              <a href="${affiliateUrl}"
                 target="_blank"
                 rel="noopener noreferrer"
                 class="product-button"
                 onclick="console.log('🛒 Product clicked:', '${brand}', '${affiliateUrl}'); trackProductClick('${brand}', '${name}', ${index + 1}); return true;">
                🛒 Get This Product
              </a>`;
          } else {
            buttonHtml = `
              <div class="product-button product-button-disabled">
                💼 Professional Product
              </div>`;
          }

          card.innerHTML = `
            <div class="product-header">
              <div class="product-image">
                ${productImageHtml}
              </div>
              <div class="product-info">
                <div class="product-brand">${brand}</div>
                <div class="product-name">${name}</div>
                <div class="product-category">${category || 'Product'}</div>
              </div>
            </div>
            <div class="product-description">
              ${notes || 'Professional-grade product used in your styling session.'}
            </div>
            ${buttonHtml}
          `;

          productsGrid.appendChild(card);
          console.log(`✅ Added product: ${brand} ${name} (${hasValidUrl ? 'CLICKABLE' : 'DISABLED'})`);
        } else {
          console.log(`❌ Skipping product - missing brand (${!!brand}) or name (${!!name})`);
        }
      });

      productsSection.style.display = 'block';
      console.log('🎉 Products section displayed');
      console.log('🔍 END DUAL FORMAT PROCESSING 🔍\n');
    }

    // Generate unique tracking ID for each product click
    function generateTrackingId() {
      return 'pms_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }

    // Enhanced product click tracking with detailed data
    async function trackProductClick(brand, name, index) {
      console.log(`🛒 Product click tracked: ${brand} ${name} (index: ${index})`);
      showToast(`Opening ${brand} ${name}...`);

      const mediaSendId = getMediaSendId();
      if (!mediaSendId) {
        console.error('No mediaSendId found for detailed tracking');
        return true;
      }

      // Generate unique tracking ID for this click
      const trackingId = generateTrackingId();

      try {
        // Get product details from the clicked element
        const productCards = document.querySelectorAll('.product-card');
        const productCard = productCards[index - 1]; // index is 1-based

        let productData = {
          brand: brand,
          name: name,
          category: 'Product', // Default
          productUrl: null
        };

        if (productCard) {
          const categoryElement = productCard.querySelector('.product-category');
          const linkElement = productCard.querySelector('.product-button');

          if (categoryElement) {
            productData.category = categoryElement.textContent.trim();
          }

          if (linkElement && linkElement.href) {
            productData.productUrl = linkElement.href;
          }
        }

        // Record detailed product interaction
        await recordProductInteraction({
          mediaSendId: mediaSendId,
          trackingId: trackingId,
          productBrand: productData.brand,
          productName: productData.name,
          productCategory: productData.category,
          productUrl: productData.productUrl
        });

        // Update aggregate counter in media_send (this should now work!)
        reportShareToSupabase('product_clicks', mediaSendId);

        console.log(`📊 Detailed tracking recorded with ID: ${trackingId}`);

      } catch (error) {
        console.error('Error in detailed product tracking:', error);
        // Fallback to basic tracking
        reportShareToSupabase('product_clicks', mediaSendId);
      }

      return true;
    }

    // Record detailed product interaction
    async function recordProductInteraction(data) {
      try {
        const response = await fetch(`${SUPABASE_URL}/rest/v1/product_interactions`, {
          method: 'POST',
          headers: {
            'apikey': SUPABASE_API_KEY,
            'Authorization': `Bearer ${SUPABASE_API_KEY}`,
            'Content-Type': 'application/json',
            'Prefer': 'return=representation'
          },
          body: JSON.stringify({
            media_send_id: data.mediaSendId,
            tracking_id: data.trackingId,
            product_brand: data.productBrand,
            product_name: data.productName,
            product_category: data.productCategory,
            product_url: data.productUrl,
            user_agent: navigator.userAgent
          })
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const result = await response.json();
        console.log('Product interaction recorded:', result);

      } catch (error) {
        console.error('Failed to record product interaction:', error);
        throw error;
      }
    }

    // UPDATED: Enhanced image creation function with before/after indicators
    function createWatermarkedImageElement(url, salonName, index) {
      const container = document.createElement('div');
      container.className = 'media-container';

      // Create canvas for watermarked image
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');

      // Create original img element for display
      const img = document.createElement('img');
      img.src = url;
      img.alt = 'Your New Style';
      img.className = 'media-item';
      img.setAttribute('data-index', index);
      img.setAttribute('data-url', url);
      img.crossOrigin = 'anonymous'; // For CORS if needed

      // Create watermarked version when image loads
      img.onload = function() {
        try {
          // Set canvas size to match image
          canvas.width = img.naturalWidth;
          canvas.height = img.naturalHeight;

          // Draw original image
          ctx.drawImage(img, 0, 0);

          // Add watermark
          const fontSize = Math.max(20, canvas.width * 0.025); // Responsive font size
          ctx.font = `bold ${fontSize}px Arial, sans-serif`;
          ctx.textAlign = 'left';

          // Position watermark in bottom-left
          const padding = Math.max(15, canvas.width * 0.02);
          const textWidth = ctx.measureText(salonName).width;
          const x = padding;
          const y = canvas.height - padding;

          // Draw semi-transparent background rectangle
          ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
          ctx.fillRect(x - 8, y - fontSize - 3, textWidth + 16, fontSize + 10);

          // Draw white text
          ctx.fillStyle = 'white';
          ctx.fillText(salonName, x, y - 3);

          // Convert to blob and create download URL
          canvas.toBlob(function(blob) {
            if (blob) {
              const watermarkedUrl = URL.createObjectURL(blob);
              img.setAttribute('data-watermarked-url', watermarkedUrl);
              console.log(`✅ Watermarked image created for: ${salonName}`);
            }
          }, 'image/jpeg', 0.92);

        } catch (error) {
          console.error('Canvas watermarking failed:', error);
          // Fallback to original URL if canvas fails
          img.setAttribute('data-watermarked-url', url);
        }
      };

      // Enable tap to view for all devices
      img.style.cursor = 'pointer';
      img.onclick = function() {
        const displayUrl = img.getAttribute('data-watermarked-url') || url;
        showImageModal(displayUrl);
      };

      // Visual watermark overlay (for immediate display)
      const watermark = document.createElement('div');
      watermark.className = 'watermark';
      watermark.textContent = salonName;

      const saveButtonContainer = document.createElement('div');
      saveButtonContainer.className = 'media-actions';
      const saveButton = document.createElement('button');
      saveButton.className = 'save-button';
      saveButton.textContent = 'Save Photo';
      saveButton.id = `saveButton${index}`;
      saveButton.onclick = function() {
        // Use watermarked version for download
        const downloadUrl = img.getAttribute('data-watermarked-url') || url;
        savePhoto(downloadUrl, index, this);
      };
      saveButtonContainer.appendChild(saveButton);

      // NEW: Add before/after indicator
      const photoIndicator = createPhotoIndicator(index - 1); // index is 1-based, but our arrays are 0-based
      saveButtonContainer.appendChild(photoIndicator);

      img.onerror = function() {
        this.onerror = null;
        this.src = 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="150" height="150"><rect width="150" height="150" fill="%23f5f5f5"/><text x="75" y="75" font-size="14" text-anchor="middle" fill="%23999">Image Error</text></svg>';
      };

      container.appendChild(img);
      container.appendChild(watermark);
      const wrapper = document.createElement('div');
      wrapper.appendChild(container);
      wrapper.appendChild(saveButtonContainer);

      return wrapper;
    }

    // FIXED: Photo functions with working download approach
    function savePhoto(url, index, button) {
      if (button) {
        button.textContent = 'Saving...';
        button.className = 'save-button saving';
        button.disabled = true;
      }

      try {
        if (isIOS) {
          // For iOS, show the modal for manual saving to Photos app
          showImageModal(url);
          if (button) {
            setTimeout(() => {
              button.textContent = 'Save Photo';
              button.className = 'save-button';
              button.disabled = false;
            }, 1000);
          }
          return;
        }

        // For all other devices, use the working direct download
        directDownload(url, `PostMyStyle-${index}.jpg`);

        if (button) {
          button.textContent = 'Saved!';
          button.className = 'save-button saved';
          setTimeout(() => {
            button.textContent = 'Save Photo';
            button.className = 'save-button';
            button.disabled = false;
          }, 2000);
        }

        showToast(`Saving photo ${index}...`);

      } catch (error) {
        console.error('Error in savePhoto:', error);
        if (button) {
          button.textContent = 'Retry';
          button.className = 'save-button error';
          button.disabled = false;
        }
        showToast('Could not save photo. Please try again.');
      }
    }

    function saveAllPhotos() {
      const mediaItems = document.querySelectorAll('.media-item');
      if (mediaItems.length === 0) {
        showToast('No photos to save');
        return;
      }

      if (isIOS) {
        showHelpModal();
        return;
      }

      showToast(`Saving ${mediaItems.length} watermarked photos...`);
      mediaItems.forEach((item, index) => {
        setTimeout(() => {
          const buttonId = `saveButton${index + 1}`;
          const button = document.getElementById(buttonId);
          // Use watermarked URL if available, fallback to original
          const downloadUrl = item.getAttribute('data-watermarked-url') ||
                             item.getAttribute('data-url') ||
                             item.src;
          savePhoto(downloadUrl, index + 1, button);
        }, index * 800);
      });
    }

    // Social media functions
    function getMediaSendId() {
      if (globalMediaSendId) {
        return globalMediaSendId;
      }
      const urlParams = new URLSearchParams(window.location.search);
      const urlMediaSendId = urlParams.get('mediaSendId');
      if (urlMediaSendId) {
        return urlMediaSendId;
      }
      return null;
    }

    function trackSocialClick(platform, mediaSendId) {
      if (!mediaSendId) {
        console.error('No mediaSendId for social tracking');
        return;
      }

      console.log(`Tracking ${platform} with mediaSendId:`, mediaSendId);

      switch(platform) {
        case 'instagram':
          reportShareToSupabase('share_instagram', mediaSendId);
          break;
        case 'facebook':
          reportShareToSupabase('share_facebook', mediaSendId);
          break;
        case 'tiktok':
          reportShareToSupabase('share_tiktok', mediaSendId);
          break;
      }
    }

    // FIXED: Social platform function with native app deep links
    function openSocialPlatform(platform) {
      console.log(`🔗 Opening ${platform} - Device: ${isIOS ? 'iOS' : isAndroid ? 'Android' : 'Desktop'}`);

      if (isMobile) {
        // Try native app first on mobile devices
        const appSchemes = {
          'instagram': 'instagram://camera',
          'facebook': 'fb://composer',
          'tiktok': 'snssdk1233://camera' // TikTok's scheme
        };

        const webFallbacks = {
          'instagram': 'https://www.instagram.com/',
          'facebook': 'https://www.facebook.com/',
          'tiktok': 'https://www.tiktok.com/'
        };

        const appScheme = appSchemes[platform];
        const webFallback = webFallbacks[platform];

        if (appScheme) {
          console.log(`📱 Trying native app scheme: ${appScheme}`);

          // Create a hidden iframe to test if the app opens
          const iframe = document.createElement('iframe');
          iframe.style.display = 'none';
          iframe.src = appScheme;
          document.body.appendChild(iframe);

          // Fallback to web version after a short delay
          setTimeout(() => {
            console.log(`🌐 Fallback: Opening web version: ${webFallback}`);
            window.open(webFallback, '_blank');

            // Clean up iframe
            if (iframe && iframe.parentNode) {
              iframe.parentNode.removeChild(iframe);
            }
          }, 1000);

          // Remove iframe after app attempt
          setTimeout(() => {
            if (iframe && iframe.parentNode) {
              iframe.parentNode.removeChild(iframe);
            }
          }, 2000);

        } else {
          // No app scheme available, open web version
          console.log(`🌐 No app scheme, opening web: ${webFallback}`);
          window.open(webFallback, '_blank');
        }

      } else {
        // Desktop: just open web versions
        const webUrls = {
          'instagram': 'https://www.instagram.com/',
          'facebook': 'https://www.facebook.com/',
          'tiktok': 'https://www.tiktok.com/'
        };

        const url = webUrls[platform];
        if (url) {
          console.log(`💻 Desktop: Opening web version: ${url}`);
          window.open(url, '_blank');
        }
      }
    }

    // ENHANCED: Page data processing with AI messages and before/after photo support
    async function processPageData(data) {
      console.log('processPageData called with:', data);

      document.getElementById('loading').style.display = 'none';
      document.getElementById('content').style.display = 'block';

      let parsedData = data;
      if (typeof data.data === 'string' && data.data_parsed) {
        parsedData = data.data_parsed;
      }

      console.log('Final parsed data for processing:', parsedData);

      const fullClientName = parsedData.clientName || getURLParameters().clientName || '';
      const clientName = getFirstName(fullClientName);
      const salonName = parsedData.salonName || getURLParameters().salonName || 'Salon';
      const googlePlaceId = parsedData.google_place_id || getURLParameters().google_place_id;
      googleReviewUrl = googlePlaceId ? `https://search.google.com/local/writereview?placeid=${googlePlaceId}` : null;
      const stylistName = parsedData.stylistName || getURLParameters().stylistName || 'Stylist';
      const caption = parsedData.caption || getURLParameters().caption || '';

      // Extract and store social media handles
      globalInstagramHandle = parsedData.instagram_handle || getURLParameters().instagram_handle || '';
      globalFacebookHandle = parsedData.facebook_handle || getURLParameters().facebook_handle || '';
      globalTikTokHandle = parsedData.tiktok_handle || getURLParameters().tiktok_handle || '';

      // NEW: Extract and store AI messages
      globalAISMSMessage = parsedData.aiSMSMessage || getURLParameters().ai_sms_message || '';
      globalAISocialCaption = parsedData.aiSocialCaption || getURLParameters().ai_social_caption || '';

      // NEW: Extract and store before/after photo indices - handle both formats
      const beforeIndicesData = parsedData.beforePhotoIndices || getURLParameters().before_photo_indices || '';
      const afterIndicesData = parsedData.afterPhotoIndices || getURLParameters().after_photo_indices || '';

      globalBeforePhotoIndices = parsePhotoIndices(beforeIndicesData);
      globalAfterPhotoIndices = parsePhotoIndices(afterIndicesData);

      console.log('🔗 Social Media Handles:');
      console.log(`Instagram: "${globalInstagramHandle}"`);
      console.log(`Facebook: "${globalFacebookHandle}"`);
      console.log(`TikTok: "${globalTikTokHandle}"`);
      console.log('🤖 AI Messages:');
      console.log(`SMS Message: "${globalAISMSMessage}"`);
      console.log(`Social Caption: "${globalAISocialCaption}"`);
      console.log('📸 Before/After Photo Indices:');
      console.log(`Before Photos: [${globalBeforePhotoIndices.join(', ')}]`);
      console.log(`After Photos: [${globalAfterPhotoIndices.join(', ')}]`);

      // UPDATED: Update header text to include salon and stylist names
      const headerElement = document.getElementById('dynamic-header');
      if (salonName && stylistName && salonName !== 'Salon' && stylistName !== 'Stylist') {
        headerElement.textContent = `${salonName} and ${stylistName} Would Love If You Could Share Your New Look!`;
      } else if (salonName && salonName !== 'Salon') {
        headerElement.textContent = `${salonName} Would Love If You Could Share Your New Look!`;
      } else if (stylistName && stylistName !== 'Stylist') {
        headerElement.textContent = `${stylistName} Would Love If You Could Share Your New Look!`;
      } else {
        headerElement.textContent = 'Share Your New Look!';
      }

      // ENHANCED: Display AI message if available
      if (globalAISMSMessage && globalAISMSMessage.trim() !== '') {
        const aiMessageContainer = document.createElement('div');
        aiMessageContainer.className = 'ai-message-container';
        aiMessageContainer.innerHTML = `
          <div class="ai-message-header">
            <span>💕</span>
            <h4>Personal Message from ${stylistName}</h4>
          </div>
          <p class="ai-message-text">"${globalAISMSMessage}"</p>
        `;

        // Insert before progress container
        const progressContainer = document.querySelector('.progress-container');
        if (progressContainer) {
          progressContainer.insertAdjacentElement('beforebegin', aiMessageContainer);
        }
      } else if (clientName) {
        document.getElementById('personal-message').textContent = `${clientName}, you look fantastic! Post your style and let your friends know! I've also included the products we used if you decide to use them at home.`;
      } else {
        document.getElementById('personal-message').textContent = "You look fantastic! Post your style and let your friends know! I've also included the products we used if you decide to use them at home.";
      }

      // Create and insert caption section if caption exists
      if (caption) {
        const captionElement = document.createElement('div');
        captionElement.id = 'caption';
        captionElement.textContent = caption;

        // Insert after save section, before smart actions
        const saveSection = document.querySelector('.save-your-style-section');
        const smartActionsSection = document.querySelector('.smart-actions-container');

        const captionSection = document.createElement('div');
        captionSection.style.margin = '20px 0';
        captionSection.innerHTML = `
          <h3 style="text-align: center; color: #333; margin-bottom: 15px;">📋 Your Caption</h3>
          <div id="caption" style="margin: 15px auto; padding: 15px; background: #f5f5f5; border-radius: 8px; font-family: 'Courier New', monospace; color: #333; max-width: 100%; box-sizing: border-box;">${caption}</div>
        `;

        saveSection.insertAdjacentElement('afterend', captionSection);
      }

      // Process product data with dual format support
      processProductData(parsedData);

      // Process media
      const mediaGrid = document.getElementById('mediaGrid');
      mediaGrid.innerHTML = '';
      let index = 1;
      let mediaCount = 0;
      while (parsedData[`mediaUrl${index}`] || getURLParameters()[`mediaUrl${index}`]) {
        const url = parsedData[`mediaUrl${index}`] || getURLParameters()[`mediaUrl${index}`];
        if (url) {
          mediaCount++;
          const fileType = url.split('.').pop().toLowerCase();
          const isVideo = fileType === 'mp4' || fileType === 'mov' || fileType === 'webm';
          if (isVideo) {
            const container = document.createElement('div');
            container.className = 'media-container';
            const video = document.createElement('video');
            video.src = url;
            video.className = 'media-item';
            video.controls = true;
            video.setAttribute('data-url', url);
            const watermark = document.createElement('div');
            watermark.className = 'watermark';
            watermark.textContent = salonName;
            const saveButtonContainer = document.createElement('div');
            saveButtonContainer.className = 'media-actions';
            const saveButton = document.createElement('button');
            saveButton.className = 'save-button';
            saveButton.textContent = 'Save Video';
            saveButton.id = `saveButton${index}`;
            saveButton.onclick = function() {
              savePhoto(url, index, this);
            };
            saveButtonContainer.appendChild(saveButton);

            // NEW: Add before/after indicator for videos too
            const photoIndicator = createPhotoIndicator(index - 1);
            saveButtonContainer.appendChild(photoIndicator);

            container.appendChild(video);
            container.appendChild(watermark);
            const wrapper = document.createElement('div');
            wrapper.appendChild(container);
            wrapper.appendChild(saveButtonContainer);
            mediaGrid.appendChild(wrapper);
          } else {
            const imageElement = createWatermarkedImageElement(url, salonName, index);
            mediaGrid.appendChild(imageElement);
          }
        }
        index++;
      }
      if (mediaCount === 0) {
        const noMedia = document.createElement('p');
        noMedia.textContent = 'No photos or videos found';
        noMedia.style.color = '#888';
        mediaGrid.appendChild(noMedia);
      }
      if (isIOS && mediaCount > 0) {
        const instruction = document.createElement('div');
        instruction.className = 'instruction';
        instruction.innerHTML = '<strong>📸 iOS:</strong> Smart Share buttons copy captions and try to download photos. If downloads go to browser folder instead of Photos, use the manual method: tap any photo → full screen → press & hold → "Add to Photos".';
        mediaGrid.parentNode.insertBefore(instruction, mediaGrid);
      }

      // Add Instagram-specific tip for mobile users
      if ((isIOS || isAndroid) && mediaCount > 0) {
        const instagramTip = document.createElement('div');
        instagramTip.className = 'instruction';
        instagramTip.style.marginTop = '15px';
        instagramTip.innerHTML = `
          <strong>📸 For Social Media:</strong>
          Your saved photos include the <strong>${salonName}</strong> watermark embedded permanently.
          Perfect for sharing your new look across all social media platforms!
        `;
        mediaGrid.parentNode.appendChild(instagramTip);
      }

      // NEW: Add before/after explanation if any photos are marked
      if (globalBeforePhotoIndices.length > 0 || globalAfterPhotoIndices.length > 0) {
        const beforeAfterTip = document.createElement('div');
        beforeAfterTip.className = 'instruction';
        beforeAfterTip.style.marginTop = '15px';
        beforeAfterTip.style.background = 'linear-gradient(135deg, rgba(76, 175, 80, 0.1), rgba(33, 150, 243, 0.1))';
        beforeAfterTip.style.borderLeft = '4px solid #4CAF50';

        let tipText = '<strong>🔄 Before & After Photos:</strong> ';

        if (globalBeforePhotoIndices.length > 0 && globalAfterPhotoIndices.length > 0) {
          tipText += `Your stylist has marked ${globalBeforePhotoIndices.length} "Before" photo${globalBeforePhotoIndices.length > 1 ? 's' : ''} and ${globalAfterPhotoIndices.length} "After" photo${globalAfterPhotoIndices.length > 1 ? 's' : ''} to showcase your amazing transformation! Share the ones you love most.`;
        } else if (globalBeforePhotoIndices.length > 0) {
          tipText += `Your stylist has marked ${globalBeforePhotoIndices.length} "Before" photo${globalBeforePhotoIndices.length > 1 ? 's' : ''} showing your starting point.`;
        } else if (globalAfterPhotoIndices.length > 0) {
          tipText += `Your stylist has marked ${globalAfterPhotoIndices.length} "After" photo${globalAfterPhotoIndices.length > 1 ? 's' : ''} showcasing your beautiful results.`;
        }

        beforeAfterTip.innerHTML = tipText;
        mediaGrid.parentNode.appendChild(beforeAfterTip);
      }
    }

    // Supabase function
    async function reportShareToSupabase(fieldName, mediaSendId) {
      if (!mediaSendId) {
        console.error('No mediaSendId found, cannot report to Supabase.');
        return;
      }
      try {
        console.log(`Updating Supabase: Field ${fieldName} for ID ${mediaSendId}`);
        const getResponse = await fetch(`${SUPABASE_URL}/rest/v1/media_send?id=eq.${mediaSendId}&select=${fieldName}`, {
          method: 'GET',
          headers: {
            'apikey': SUPABASE_API_KEY,
            'Authorization': `Bearer ${SUPABASE_API_KEY}`,
            'Content-Type': 'application/json'
          }
        });
        if (!getResponse.ok) {
          console.error('Failed to get current value:', getResponse.status);
          return;
        }
        const data = await getResponse.json();
        const currentValue = data[0] && data[0][fieldName] ? data[0][fieldName] : 0;
        const newValue = currentValue + 1;
        const updateResponse = await fetch(`${SUPABASE_URL}/rest/v1/media_send?id=eq.${mediaSendId}`, {
          method: 'PATCH',
          headers: {
            'apikey': SUPABASE_API_KEY,
            'Authorization': `Bearer ${SUPABASE_API_KEY}`,
            'Content-Type': 'application/json',
            'Prefer': 'return=representation'
          },
          body: JSON.stringify({ [fieldName]: newValue })
        });
        if (!updateResponse.ok) {
          console.error('Supabase update error:', updateResponse.status, await updateResponse.text());
        } else {
          console.log(`Successfully updated ${fieldName} to ${newValue} in Supabase`);
        }
      } catch (error) {
        console.error('Failed to update Supabase:', error);
      }
    }

    // Mobile Branch handling
    function handleMobileBranchFlow() {
      let attempts = 0;
      const maxAttempts = 20;

      function tryBranchData() {
        attempts++;
        console.log(`Branch attempt ${attempts}/${maxAttempts}`);

        if (typeof branch === 'undefined') {
          if (attempts < maxAttempts) {
            setTimeout(tryBranchData, 500);
          } else {
            console.error('Branch SDK timeout');
            processPageData(getURLParameters());
          }
          return;
        }

        branch.data(function(err, data) {
          console.log('Branch callback executed');
          console.log('Branch data:', data);

          if (err || !data) {
            console.error('Branch error:', err);
            processPageData(getURLParameters());
            return;
          }

          if (data.data_parsed && data.data_parsed.mediaSendId) {
            console.log('Found mediaSendId in Branch data_parsed:', data.data_parsed.mediaSendId);
            globalMediaSendId = data.data_parsed.mediaSendId;
            reportShareToSupabase('click_count', data.data_parsed.mediaSendId);
            processPageData(data.data_parsed);
          } else {
            console.log('No mediaSendId in Branch data_parsed');
            processPageData(getURLParameters());
          }
        });
      }

      tryBranchData();
    }

    // Event listeners
    document.getElementById('imageModal').addEventListener('click', function(event) {
      if (event.target === this) {
        closeImageModal();
      }
    });

    // Main initialization
    document.addEventListener('DOMContentLoaded', function() {
      console.log('=== PAGE LOADED ===');
      console.log('Current URL:', window.location.href);

      const urlParams = new URLSearchParams(window.location.search);
      const urlMediaSendId = urlParams.get('mediaSendId');
      const hasBranchParams = urlParams.has('_branch_match_id') || urlParams.has('_branch_referrer');

      console.log('URL mediaSendId:', urlMediaSendId);
      console.log('Has Branch parameters:', hasBranchParams);

      if (urlMediaSendId) {
        console.log('Desktop flow - using URL parameters');
        globalMediaSendId = urlMediaSendId;
        reportShareToSupabase('click_count', urlMediaSendId);

        // Get URL parameters and process
        const urlData = getURLParameters();
        console.log('URL data for processing:', urlData);
        processPageData(urlData);
      } else if (hasBranchParams) {
        console.log('Mobile Branch flow - waiting for Branch SDK');
        handleMobileBranchFlow();
      } else {
        console.log('No mediaSendId or Branch parameters found');
        const loadingTimeout = setTimeout(() => {
          const urlData = getURLParameters();
          console.log('Fallback - using URL data:', urlData);
          processPageData(urlData);
        }, 5000);

        if (typeof branch !== 'undefined' && branch.data) {
          branch.data(function(err, data) {
            clearTimeout(loadingTimeout);
            if (err || !data || Object.keys(data).length === 0) {
              console.log('No Branch data found. Using URL parameters.');
              const urlData = getURLParameters();
              console.log('Branch fallback - using URL data:', urlData);
              processPageData(urlData);
            } else {
              console.log('Branch data received:', data);
              if (data.mediaSendId) {
                globalMediaSendId = data.mediaSendId;
                reportShareToSupabase('click_count', data.mediaSendId);
              }
              processPageData(data);
            }
          });
        } else {
          clearTimeout(loadingTimeout);
          const urlData = getURLParameters();
          console.log('No Branch SDK - using URL data:', urlData);
          processPageData(urlData);
        }
      }
    });
</script>
</body>
</html>