<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Share Your New Look - PostMyStyle</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
          font-family: 'Helvetica Neue', Arial, sans-serif;
          background: #ffffff;
          text-align: center;
          padding: 20px;
          color: #222;
          margin: 0;
        }
        .container {
          max-width: 600px;
          margin: 0 auto;
          padding: 0 20px;
        }
        .brand-header {
          font-size: 32px;
          font-weight: bold;
          margin-bottom: 15px;
          background: linear-gradient(to right, #3b82f6, #6366f1);
          -webkit-background-clip: text;
          background-clip: text;
          color: transparent;
          display: inline-block;
          text-shadow: 0px 1px 2px rgba(99,102,241,0.2);
          letter-spacing: 1px;
        }
        .brand-logo {
          max-width: 300px;
          width: 100%;
          height: auto;
          margin: 10px auto 20px auto;
          display: block;
        }
        .divider-line {
          border: none;
          height: 2px;
          background: linear-gradient(to right, #3b82f6, #6366f1);
          margin: 20px auto;
          width: 80%;
          max-width: 300px;
        }
        h1 {
          font-size: 28px;
          font-weight: bold;
          margin-bottom: 10px;
          color: #111;
        }
        h2 {
          font-size: 20px;
          margin-top: 20px;
          color: #333;
        }
        #personal-message {
          font-size: 20px;
          margin: 20px 0;
          color: #3b82f6;
          font-weight: bold;
        }
        .ai-message-container {
          background: linear-gradient(135deg, #f8f9ff, #e0e7ff);
          padding: 20px;
          border-radius: 12px;
          margin: 20px 0;
          border-left: 4px solid #3b82f6;
          text-align: left;
        }
        .ai-message-header {
          display: flex;
          align-items: center;
          gap: 10px;
          margin-bottom: 12px;
        }
        .ai-message-header h4 {
          margin: 0;
          color: #3b82f6;
          font-size: 16px;
        }
        .ai-message-text {
          font-style: italic;
          color: #555;
          font-size: 16px;
          line-height: 1.4;
          margin: 0;
        }
        #salonStylist {
          font-size: 18px;
          margin-top: 5px;
          color: #666;
          white-space: pre-line;
        }
        #caption {
          margin: 20px auto;
          font-size: 16px;
          color: #333;
          font-family: 'Courier New', Courier, monospace;
          padding: 15px;
          background: #f5f5f5;
          border-radius: 8px;
          word-wrap: break-word;
          text-align: center !important;
          width: 100%;
          max-width: 100%;
          box-sizing: border-box;
        }
        .media-grid {
          display: flex;
          flex-wrap: wrap;
          justify-content: center !important;
          gap: 15px;
          margin: 20px auto !important;
          width: 100%;
          padding: 0 10px;
          box-sizing: border-box;
        }
        .media-container {
          position: relative;
          width: 150px;
          height: 150px;
          margin: 0 auto 20px;
          overflow: hidden;
          border-radius: 10px;
          box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .media-item {
          width: 100%;
          height: 100%;
          object-fit: cover;
          border-radius: 10px;
          display: block;
        }
        .watermark {
          position: absolute;
          left: 8px;
          bottom: 8px;
          background-color: rgba(0, 0, 0, 0.6);
          color: white;
          padding: 3px 8px;
          border-radius: 4px;
          font-size: 12px;
          pointer-events: none;
          max-width: 90%;
          overflow: hidden;
          text-overflow: ellipsis;
          white-space: nowrap;
        }
        .media-actions {
          margin-top: 5px;
          text-align: center;
          width: 100%;
        }
        .save-button {
          background: #3b82f6;
          color: white;
          border: none;
          border-radius: 15px;
          padding: 6px 12px;
          font-size: 12px;
          cursor: pointer;
          margin: 5px 0;
          width: 100%;
          font-weight: bold;
        }
        .save-button:hover {
          background: #1e40af;
        }
        .photo-indicator {
          text-align: center;
          margin-top: 8px;
          font-size: 13px;
          font-weight: 600;
          padding: 4px 8px;
          border-radius: 12px;
          display: inline-block;
          min-width: 60px;
        }
        .photo-indicator.before {
          background: linear-gradient(135deg, #4CAF50, #45a049);
          color: white;
        }
        .photo-indicator.after {
          background: linear-gradient(135deg, #2196F3, #1976d2);
          color: white;
        }
        .photo-indicator.none {
          background: #f0f0f0;
          color: #666;
        }
        .button {
          display: block !important;
          margin: 15px auto !important;
          padding: 14px 24px;
          background: black;
          color: white;
          border: none;
          border-radius: 30px;
          font-size: 18px;
          cursor: pointer;
          font-weight: bold;
          transition: all 0.2s;
          width: auto;
          max-width: 90%;
          text-align: center;
        }
        .button:hover {
          background: #333;
          box-shadow: 0 3px 8px rgba(0,0,0,0.15);
        }
        .button:active {
          opacity: 0.8;
          transform: scale(0.98);
        }
        .social-buttons {
          display: flex;
          justify-content: center !important;
          gap: 12px;
          margin: 25px auto !important;
          width: 100%;
          flex-wrap: nowrap;
          max-width: 240px;
        }
        .icon-button {
          display: flex;
          flex-direction: column;
          align-items: center;
          background: none;
          border: none;
          cursor: pointer;
          flex: 1;
          min-width: 0;
        }
        .icon-label {
          margin-top: 5px;
          font-size: 12px;
          color: #555;
          text-align: center;
          white-space: nowrap;
        }
        .social-icon {
          width: 50px;
          height: 50px;
          transition: all 0.3s ease;
          border-radius: 50%;
          flex-shrink: 0;
        }
        .social-icon:hover {
          transform: scale(1.15);
          box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.2);
        }
        .instruction {
          font-size: 14px;
          margin: 15px 0;
          color: #333;
          background-color: #f9f9f9;
          padding: 10px;
          border-radius: 8px;
          border-left: 3px solid #3b82f6;
        }
        .instruction strong {
          color: #3b82f6;
        }
        footer {
          margin-top: 30px;
          font-size: 12px;
          color: #aaa;
        }
        .toast {
          position: fixed;
          bottom: 20px;
          left: 50%;
          transform: translateX(-50%);
          background: rgba(0, 0, 0, 0.8);
          color: white;
          padding: 10px 20px;
          border-radius: 20px;
          font-size: 16px;
          display: none;
          z-index: 1000;
        }
        .loading {
          display: flex;
          justify-content: center;
          align-items: center;
          height: 200px;
          flex-direction: column;
        }
        .spinner {
          width: 40px;
          height: 40px;
          border: 4px solid #f3f3f3;
          border-top: 4px solid #3b82f6;
          border-radius: 50%;
          animation: spin 1s linear infinite;
          margin-bottom: 15px;
        }
        .download-all-container {
          background: rgba(59, 130, 246, 0.1);
          padding: 15px;
          border-radius: 10px;
          margin: 20px auto;
          border: 1px solid rgba(59, 130, 246, 0.3);
          text-align: center !important;
          width: 100%;
          max-width: 100%;
          box-sizing: border-box;
        }
        .modal {
          display: none;
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background-color: rgba(0, 0, 0, 0.7);
          z-index: 1000;
          overflow: auto;
        }
        .modal-content {
          position: relative;
          background-color: #fff;
          margin: 10% auto;
          padding: 20px;
          border-radius: 15px;
          width: 80%;
          max-width: 500px;
          text-align: center;
        }
        .close-modal {
          position: absolute;
          top: 10px;
          right: 15px;
          font-size: 24px;
          font-weight: bold;
          cursor: pointer;
        }
        .save-instructions {
          padding: 20px;
          text-align: left;
        }
        .save-instructions li {
          margin-bottom: 10px;
        }
        .save-instructions img {
          max-width: 100%;
          height: auto;
          margin: 10px 0;
          border-radius: 8px;
          border: 1px solid #eee;
        }
        .help-badge {
          display: inline-block;
          background: #3b82f6;
          color: white;
          width: 20px;
          height: 20px;
          border-radius: 50%;
          text-align: center;
          line-height: 20px;
          margin-left: 5px;
          font-size: 14px;
          cursor: pointer;
        }
        .image-modal {
          display: none;
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background-color: rgba(0, 0, 0, 0.9);
          z-index: 1001;
          overflow: hidden;
          text-align: center;
        }
        .image-modal-content {
          position: relative;
          margin: 10vh auto;
          width: 90%;
          max-width: 800px;
          max-height: 80vh;
        }
        .image-modal img {
          max-width: 100%;
          max-height: 70vh;
          object-fit: contain;
          border-radius: 8px;
        }
        .image-modal-close {
          position: fixed;
          top: 20px;
          right: 20px;
          color: white;
          font-size: 36px;
          font-weight: bold;
          cursor: pointer;
          background-color: #3b82f6;
          width: 50px;
          height: 50px;
          line-height: 50px;
          text-align: center;
          border-radius: 50%;
          z-index: 1002;
          box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }
        .image-modal-close:hover {
          background-color: #1e40af;
          transform: scale(1.1);
        }
        .save-instruction-overlay {
          position: absolute;
          bottom: 20px;
          left: 0;
          width: 100%;
          color: white;
          background-color: rgba(0, 0, 0, 0.6);
          padding: 10px 0;
          font-size: 16px;
          border-radius: 0 0 8px 8px;
        }
        .step {
          margin: 20px 0;
          padding: 15px;
          background: #f9f9f9;
          border-radius: 10px;
          text-align: left;
        }
        .step-number {
          display: inline-block;
          width: 25px;
          height: 25px;
          background: #3b82f6;
          color: #fff;
          text-align: center;
          line-height: 25px;
          border-radius: 50%;
          margin-right: 10px;
        }
        .step-title {
          display: inline;
          font-weight: bold;
          font-size: 18px;
        }
        .step-content {
          margin-top: 10px;
          margin-left: 35px;
          display: flex;
          flex-direction: column;
          align-items: center;
          text-align: center;
        }
        .step-content p {
          text-align: center !important;
          width: 100%;
          margin: 10px 0;
        }
        .save-button.saved {
          background: #4caf50;
        }
        .google-review-button {
          background: #4285F4;
          border: none;
          border-radius: 30px;
          padding: 16px 24px;
          display: flex !important;
          justify-content: center;
          align-items: center;
          min-width: 220px;
          max-width: 90%;
          cursor: pointer;
          transition: background-color 0.3s ease;
          margin: 15px auto !important;
          gap: 15px;
          color: white;
          font-weight: bold;
          font-size: 16px;
          text-align: center;
          box-sizing: border-box;
        }
        .google-review-button:hover {
          background-color: #357ae8;
        }
        .google-icon {
          width: 36px !important;
          height: 36px !important;
          flex-shrink: 0;
          display: inline-block;
        }
        .save-button.saving {
          background: #ffc107;
          cursor: not-allowed;
        }
        .save-button.error {
          background: #f44336;
        }
        .progress-container {
          margin: 20px 0 30px 0;
          text-align: center;
        }
        .progress-steps {
          display: flex;
          justify-content: center;
          align-items: center;
          margin-bottom: 10px;
          flex-wrap: nowrap;
          gap: 15px;
          max-width: 100%;
        }
        .progress-step {
          display: flex;
          flex-direction: column;
          align-items: center;
          opacity: 0.5;
          transition: all 0.3s ease;
          flex-shrink: 0;
          min-width: 60px;
        }
        .progress-step.active {
          opacity: 1;
          transform: scale(1.1);
        }
        .progress-step.completed {
          opacity: 0.8;
        }
        .step-circle {
          width: 40px;
          height: 40px;
          border-radius: 50%;
          background: #ddd;
          display: flex;
          align-items: center;
          justify-content: center;
          font-weight: bold;
          margin-bottom: 5px;
          transition: all 0.3s ease;
          font-size: 14px;
        }
        .progress-step.active .step-circle {
          background: linear-gradient(135deg, #3b82f6, #6366f1);
          color: white;
        }
        .progress-step.completed .step-circle {
          background: #4CAF50;
          color: white;
        }
        .progress-line {
          width: 40px;
          height: 2px;
          background: #ddd;
          margin: 0 5px;
          flex-shrink: 0;
        }
        .progress-subtitle {
          color: #666;
          font-size: 14px;
          margin: 0;
        }
        .save-your-style-section {
          margin: 30px 0;
          padding: 25px;
          background: linear-gradient(135deg, rgba(59,130,246,0.05), rgba(99,102,241,0.05));
          border-radius: 16px;
          border: 1px solid rgba(59,130,246,0.15);
        }
        .save-your-style-section h3 {
          text-align: center;
          color: #333;
          margin-bottom: 20px;
          font-size: 22px;
        }
        .smart-actions-container {
          margin: 30px 0;
          padding: 25px;
          background: linear-gradient(135deg, rgba(59,130,246,0.05), rgba(99,102,241,0.05));
          border-radius: 16px;
          border: 1px solid rgba(59,130,246,0.15);
        }
        .smart-actions-header {
          text-align: center;
          margin-bottom: 25px;
        }
        .smart-actions-header h3 {
          color: #333;
          margin-bottom: 10px;
          font-size: 22px;
          display: flex;
          align-items: center;
          justify-content: center;
          gap: 10px;
        }
        .smart-actions-header .social-icon-header {
          width: 32px;
          height: 32px;
        }
        .smart-action-grid {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
          gap: 20px;
          margin-bottom: 25px;
        }
        .smart-action-card {
          background: white;
          padding: 20px;
          border-radius: 12px;
          text-align: center;
          box-shadow: 0 4px 12px rgba(0,0,0,0.08);
          transition: all 0.3s ease;
          border: 2px solid transparent;
        }
        .smart-action-card:hover {
          transform: translateY(-2px);
          box-shadow: 0 8px 20px rgba(0,0,0,0.12);
        }
        .instagram-card:hover {
          border-color: #E4405F;
        }
        .facebook-card:hover {
          border-color: #1877F2;
        }
        .tiktok-card:hover {
          border-color: #000000;
        }
        .review-card:hover {
          border-color: #4285F4;
        }
        .action-icon {
          width: 48px;
          height: 48px;
          margin: 0 auto 15px;
          border-radius: 50%;
          display: flex;
          align-items: center;
          justify-content: center;
          background: #f8f9fa;
        }
        .action-icon img {
          width: 36px;
          height: 36px;
          border-radius: 50%;
        }
        .smart-action-card h4 {
          margin: 10px 0 5px 0 !important;
          color: #333;
          font-size: 18px;
        }
        .smart-action-card p {
          color: #666;
          font-size: 14px;
          margin-bottom: 15px !important;
          line-height: 1.4;
        }
        .smart-action-btn {
          width: 100%;
          padding: 12px 20px;
          border: none;
          border-radius: 25px;
          font-weight: 600;
          cursor: pointer;
          transition: all 0.2s ease;
          color: white;
          font-size: 14px;
        }
        .instagram-btn {
          background: linear-gradient(135deg, #E4405F, #C13584);
        }
        .facebook-btn {
          background: linear-gradient(135deg, #1877F2, #42A5F5);
        }
        .tiktok-btn {
          background: linear-gradient(135deg, #000000, #333333);
        }
        .review-btn {
          background: linear-gradient(135deg, #4285F4, #357ae8);
        }
        .smart-action-btn:hover {
          transform: scale(1.02);
          box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        .smart-action-btn:active {
          transform: scale(0.98);
        }

        /* NEW: Auto-Connect Button Styles */
        .auto-connect-btn {
          background: linear-gradient(135deg, #4CAF50, #45a049) !important;
          position: relative;
          overflow: hidden;
          margin-bottom: 8px !important;
        }

        .auto-connect-btn:before {
          content: '';
          position: absolute;
          top: 0;
          left: -100%;
          width: 100%;
          height: 100%;
          background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
          transition: left 0.5s;
        }

        .auto-connect-btn:hover:before {
          left: 100%;
        }

        .manual-btn {
          opacity: 0.8;
          font-size: 14px !important;
        }

        /* Button state styles */
        .connecting {
          background: linear-gradient(135deg, #FF9800, #F57C00) !important;
          cursor: wait !important;
        }

        .connected {
          background: linear-gradient(135deg, #4CAF50, #45a049) !important;
        }

        .error {
          background: linear-gradient(135deg, #f44336, #d32f2f) !important;
        }

        /* Social instruction styling */
        .social-instruction {
          background: linear-gradient(135deg, rgba(0, 150, 136, 0.1), rgba(76, 175, 80, 0.1));
          border: 1px solid rgba(0, 150, 136, 0.2);
          border-radius: 12px;
          padding: 16px;
          margin: 15px 0;
          text-align: left;
        }

        .social-instruction-header {
          display: flex;
          align-items: center;
          gap: 10px;
          margin-bottom: 10px;
        }

        .social-instruction h4 {
          margin: 0;
          color: #00695C;
          font-size: 16px;
        }

        .social-instruction p {
          margin: 0;
          color: #555;
          font-size: 14px;
          line-height: 1.4;
        }

        /* Products Section Styles */
        .products-section {
          margin: 25px 0;
        }
        .products-grid {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
          gap: 20px;
          margin: 20px 0;
          padding: 0 10px;
        }
        .product-card {
          background: #ffffff;
          border-radius: 12px;
          padding: 16px;
          box-shadow: 0 4px 8px rgba(0,0,0,0.1);
          transition: transform 0.2s ease, box-shadow 0.2s ease;
          border: 1px solid #f0f0f0;
        }
        .product-card:hover {
          transform: translateY(-2px);
          box-shadow: 0 6px 16px rgba(0,0,0,0.15);
        }
        .product-header {
          display: flex;
          align-items: center;
          margin-bottom: 12px;
        }
        .product-image {
          width: 60px;
          height: 60px;
          border-radius: 8px;
          background: linear-gradient(135deg, #3b82f6, #6366f1);
          display: flex;
          align-items: center;
          justify-content: center;
          color: white;
          font-weight: bold;
          font-size: 24px;
          margin-right: 12px;
          flex-shrink: 0;
          object-fit: cover;
        }
        .product-image img {
          width: 100%;
          height: 100%;
          border-radius: 8px;
          object-fit: cover;
        }
        .product-image.no-image {
          background: #f0f0f0;
          color: #999;
          font-size: 20px;
        }
        .product-info {
          flex: 1;
        }
        .product-brand {
          font-size: 12px;
          color: #3b82f6;
          font-weight: 600;
          text-transform: uppercase;
          letter-spacing: 0.5px;
        }
        .product-name {
          font-size: 16px;
          font-weight: bold;
          color: #333;
          margin: 4px 0;
        }
        .product-category {
          font-size: 12px;
          color: #666;
          background: #f8f9fa;
          padding: 2px 8px;
          border-radius: 12px;
          display: inline-block;
        }
        .product-description {
          font-size: 14px;
          color: #555;
          margin: 12px 0;
          line-height: 1.4;
        }
        .product-button {
          background: linear-gradient(135deg, #3b82f6, #6366f1) !important;
          color: white !important;
          border: none;
          border-radius: 25px;
          padding: 12px 20px;
          font-size: 14px;
          font-weight: 600;
          cursor: pointer;
          width: 100%;
          transition: all 0.2s ease;
          text-decoration: none !important;
          display: inline-block;
          text-align: center;
          box-sizing: border-box;
        }
        .product-button:hover {
          background: linear-gradient(135deg, #1e40af, #4f46e5) !important;
          transform: scale(1.02);
          text-decoration: none !important;
          color: white !important;
        }
        .product-button:visited {
          color: white !important;
          text-decoration: none !important;
        }
        .product-button:active {
          transform: scale(0.98);
        }
        .product-button:focus {
          outline: 2px solid #3b82f6;
          outline-offset: 2px;
        }
        .product-button-disabled {
          background: linear-gradient(135deg, #999, #777) !important;
          color: white !important;
          cursor: not-allowed !important;
          opacity: 0.7;
        }
        .product-button-disabled:hover {
          background: linear-gradient(135deg, #999, #777) !important;
          transform: none !important;
          text-decoration: none !important;
        }
        .products-intro {
          text-align: center;
          margin: 15px 0;
          padding: 15px;
          background: linear-gradient(135deg, rgba(255,153,0,0.1), rgba(255,193,7,0.1));
          border-radius: 12px;
          border: 1px solid rgba(255,153,0,0.2);
          grid-column: 1 / -1;
          display: flex;
          align-items: center;
          justify-content: center;
          gap: 10px;
        }
        .products-intro .amazon-icon {
          width: 24px;
          height: 24px;
          flex-shrink: 0;
        }
        .products-intro h3 {
          color: #ff9900;
          margin: 0 0 4px 0;
          font-size: 18px;
        }
        .products-intro p {
          color: #555;
          margin: 0;
          font-size: 14px;
        }
        .products-intro-content {
          flex: 1;
        }
        .step-number.products-icon {
          background: linear-gradient(135deg, #3b82f6, #6366f1);
          width: 30px;
          height: 30px;
          display: inline-flex;
          align-items: center;
          justify-content: center;
          border-radius: 50%;
          margin-right: 10px;
        }
        .step-number.products-icon img {
          width: 18px;
          height: 18px;
          filter: brightness(0) invert(1);
        }

        @keyframes spin {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
        }
        @keyframes bounce {
          0%   { transform: scale(1); }
          30%  { transform: scale(0.85); }
          60%  { transform: scale(1.2); }
          100% { transform: scale(1); }
        }

        @media screen and (max-width: 768px) {
          .brand-logo {
            max-width: 250px;
          }
          .step-content {
            margin-left: 10px;
            padding: 0 10px;
          }
          .download-all-container,
          #caption {
            margin-left: 0;
            margin-right: 0;
            width: calc(100% - 20px);
          }
          .social-buttons {
            gap: 8px;
            max-width: 200px;
          }
          .social-icon {
            width: 45px;
            height: 45px;
          }
          .icon-label {
            font-size: 11px;
          }
          .google-review-button {
            min-width: 200px;
            font-size: 15px;
            padding: 14px 20px;
          }
          .google-icon {
            width: 32px !important;
            height: 32px !important;
          }
          .instruction {
            font-size: 16px;
            padding: 15px;
            margin: 15px 0;
          }
          .step {
            padding: 20px 15px;
          }
          .save-button {
            padding: 10px 15px;
            font-size: 14px;
          }
          .modal-content {
            margin: 5% auto;
            width: 90%;
            padding: 15px;
          }
          .image-modal-content {
            margin: 15vh auto;
          }
          .products-grid {
            grid-template-columns: 1fr;
            gap: 15px;
            padding: 0 5px;
          }
          .product-card {
            padding: 14px;
          }
          .product-image {
            width: 50px;
            height: 50px;
            font-size: 20px;
          }
          .product-button {
            font-size: 13px;
            padding: 10px 16px;
          }
          .smart-action-grid {
            grid-template-columns: 1fr;
            gap: 15px;
          }
          .smart-actions-container {
            padding: 20px 15px;
          }
          .smart-actions-header .social-icon-header {
            width: 28px;
            height: 28px;
          }
          .products-intro {
            flex-direction: column;
            gap: 8px;
          }
          .progress-line {
            width: 30px;
          }
          .step-circle {
            width: 35px;
            height: 35px;
            font-size: 12px;
          }
          .progress-step {
            min-width: 50px;
          }
          .progress-steps {
            gap: 8px;
          }
          .ai-message-container {
            padding: 16px;
          }
          .photo-indicator {
            font-size: 12px;
            padding: 3px 6px;
            min-width: 50px;
          }
        }

        @supports (-webkit-touch-callout: none) {
          .step-content {
            -webkit-text-align-last: center;
          }
          .button,
          .google-review-button {
            -webkit-appearance: none;
            -webkit-tap-highlight-color: transparent;
          }
        }

        @media screen and (-webkit-min-device-pixel-ratio: 1) {
          .google-icon {
            image-rendering: -webkit-optimize-contrast;
          }
        }
    </style>

    <!-- Facebook SDK -->
    <script async defer crossorigin="anonymous"
            src="https://connect.facebook.net/en_US/sdk.js"></script>

    <!-- Instagram OAuth Configuration -->
    <script>
        // Replace with your actual app IDs
        const INSTAGRAM_CONFIG = {
          client_id: '1690627741578566', // Replace with your Instagram App ID
          redirect_uri: window.location.origin + '/instagram-callback',
          scope: 'user_profile,user_media',
          response_type: 'code'
        };

        const FACEBOOK_CONFIG = {
          appId: '1690627741578566', // Replace with your Facebook App ID
          version: 'v18.0'
        };
    </script>

    <script type="text/javascript">
        (function(b,r,a,n,c,h,_,s,d,k){if(!b[n]||!b[n]._q){for(;s<_.length;)c(h,_[s++]);d=r.createElement(a);d.async=1;d.src="https://cdn.branch.io/branch-latest.min.js";k=r.getElementsByTagName(a)[0];k.parentNode.insertBefore(d,k);b[n]=h}})(window,document,"script","branch",function(b,r){b[r]=function(){b._q.push([r,arguments])}},{_q:[],_v:1},"addListener applyCode autoAppIndex banner closeBanner closeJourney creditHistory credits data deepview deepviewCta first getCode init link logout redeem referrals removeListener sendSMS setBranchViewData setIdentity track validateCode trackCommerceEvent logEvent disableTracking".split(" "), 0);
        branch.init('key_live_jtEolBcoQrajD2oV180Klfbmqqbjhr6W');
    </script>
</head>
<body>
<div class="container">
    <img src="postmystyletitle.png" alt="PostMyStyle" class="brand-logo" onerror="this.onerror=null; this.src='data:image/svg+xml;utf8,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22300%22 height=%2280%22><text x=%2210%22 y=%2250%22 font-size=%2232%22 fill=%22%233b82f6%22 font-weight=%22bold%22>PostMyStyle</text></svg>'"/>

    <h1 id="dynamic-header">Share Your New Look!</h1>
    <hr class="divider-line">

    <div id="loading" class="loading">
        <div class="spinner"></div>
        <p>Loading your style...</p>
    </div>

    <div id="content" style="display: none;">
        <div id="personal-message"></div>

        <!-- Progress Indicator -->
        <div class="progress-container">
            <div class="progress-steps">
                <div class="progress-step active" data-step="1">
                    <div class="step-circle">1</div>
                    <span>Save</span>
                </div>
                <div class="progress-line"></div>
                <div class="progress-step" data-step="2">
                    <div class="step-circle">2</div>
                    <span>Share</span>
                </div>
                <div class="progress-line"></div>
                <div class="progress-step" data-step="3">
                    <div class="step-circle">3</div>
                    <span>Review</span>
                </div>
            </div>
            <p class="progress-subtitle">Three simple steps to share your amazing transformation!</p>
        </div>

        <!-- Save Your New Style Section -->
        <div class="save-your-style-section">
            <h3>ðŸ’¾ Save Your New Style</h3>
            <div class="download-all-container">
                <button class="button" onclick="saveAllPhotos()">Save All Photos <span class="help-badge" onclick="showHelpModal(event)">?</span></button>
            </div>
            <div class="media-grid" id="mediaGrid"></div>
        </div>

        <!-- ENHANCED: Smart Action Cards with Auto-Connect -->
        <div class="smart-actions-container">
            <div class="smart-actions-header">
                <h3>
                    <img src="social.png" alt="Share" class="social-icon-header" onerror="this.onerror=null; this.src='data:image/svg+xml;utf8,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%2232%22 height=%2232%22><rect width=%2232%22 height=%2232%22 rx=%2216%22 fill=%22%233b82f6%22/><text x=%2216%22 y=%2222%22 font-size=%2218%22 text-anchor=%22middle%22 fill=%22white%22>ðŸ“±</text></svg>'"/>
                    Quick Share and Review
                </h3>
            </div>

            <div class="smart-action-grid">
                <!-- Instagram Enhanced Card -->
                <div class="smart-action-card instagram-card">
                    <div class="action-icon">
                        <img src="instagram.png" alt="Instagram" onerror="this.onerror=null; this.src='data:image/svg+xml;utf8,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%2236%22 height=%2236%22><rect width=%2236%22 height=%2236%22 rx=%2218%22 fill=%22%23E4405F%22/><text x=%2218%22 y=%2225%22 font-size=%2220%22 text-anchor=%22middle%22 fill=%22white%22>IG</text></svg>'"/>
                    </div>
                    <h4>Share to Instagram</h4>
                    <p>Choose your preferred sharing method</p>

                    <!-- Auto-Connect Button -->
                    <button class="smart-action-btn instagram-btn auto-connect-btn"
                            onclick="connectAndPostInstagram()"
                            style="margin-bottom: 8px;">
                        ðŸ”— Auto-Connect & Post
                    </button>

                    <!-- Manual Button -->
                    <button class="smart-action-btn instagram-btn manual-btn"
                            onclick="doInstagramFlow()"
                            style="background: linear-gradient(135deg, #8E44AD, #9B59B6);">
                        ðŸ“± Manual Share
                    </button>
                </div>

                <!-- Facebook Enhanced Card -->
                <div class="smart-action-card facebook-card">
                    <div class="action-icon">
                        <img src="facebook.png" alt="Facebook" onerror="this.onerror=null; this.src='data:image/svg+xml;utf8,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%2236%22 height=%2236%22><rect width=%2236%22 height=%2236%22 rx=%2218%22 fill=%22%231877F2%22/><text x=%2218%22 y=%2225%22 font-size=%2220%22 text-anchor=%22middle%22 fill=%22white%22>FB</text></svg>'"/>
                    </div>
                    <h4>Share to Facebook</h4>
                    <p>Choose your preferred sharing method</p>

                    <!-- Auto-Connect Button -->
                    <button class="smart-action-btn facebook-btn auto-connect-btn"
                            onclick="connectAndPostFacebook()"
                            style="margin-bottom: 8px;">
                        ðŸ”— Auto-Connect & Post
                    </button>

                    <!-- Manual Button -->
                    <button class="smart-action-btn facebook-btn manual-btn"
                            onclick="doFacebookFlow()"
                            style="background: linear-gradient(135deg, #8E44AD, #9B59B6);">
                        ðŸ“± Manual Share
                    </button>
                </div>

                <!-- TikTok All-in-One -->
                <div class="smart-action-card tiktok-card">
                    <div class="action-icon">
                        <img src="tiktok.png" alt="TikTok" onerror="this.onerror=null; this.src='data:image/svg+xml;utf8,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%2236%22 height=%2236%22><rect width=%2236%22 height=%2236%22 rx=%2218%22 fill=%22%23000000%22/><text x=%2218%22 y=%2225%22 font-size=%2216%22 text-anchor=%22middle%22 fill=%22white%22>TT</text></svg>'"/>
                    </div>
                    <h4>Share to TikTok</h4>
                    <p>Save photos + Copy caption + Create your post</p>
                    <button class="smart-action-btn tiktok-btn" onclick="doTikTokFlow()">
                        Ready to Share
                    </button>
                </div>

                <!-- Google Review -->
                <div class="smart-action-card review-card">
                    <div class="action-icon">
                        <img src="google.png" alt="Google" onerror="this.onerror=null; this.src='data:image/svg+xml;utf8,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%2236%22 height=%2236%22><rect width=%2236%22 height=%2236%22 rx=%2218%22 fill=%22%234285F4%22/><text x=%2218%22 y=%2225%22 font-size=%2220%22 text-anchor=%22middle%22 fill=%22white%22>G</text></svg>'"/>
                    </div>
                    <h4>Leave a Google Review</h4>
                    <p>Enjoyed your style? Let others know</p>
                    <button class="smart-action-btn review-btn" onclick="doReviewFlow()">
                        Leave a Review
                    </button>
                </div>
            </div>
        </div>

        <!-- Products Section -->
        <div id="productsSection" class="products-section" style="display: none;">
            <div class="step">
                <div class="step-number products-icon">
                    <img src="products.png" alt="Products" onerror="this.onerror=null; this.src='data:image/svg+xml;utf8,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%2218%22 height=%2218%22><rect width=%2218%22 height=%2218%22 fill=%22white%22/><text x=%229%22 y=%2214%22 font-size=%2212%22 text-anchor=%22middle%22 fill=%22black%22>ðŸ’„</text></svg>'"/>
                </div>
                <div class="step-title">Products Used in Your Session</div>
                <div class="step-content">
                    <p>Get the same professional results at home with these products:</p>
                    <div id="productsGrid" class="products-grid"></div>
                </div>
            </div>
        </div>
    </div>

    <footer>Powered by PostMyStyle.ai</footer>
    <div id="toast" class="toast"></div>

    <!-- Help Modal -->
    <div id="helpModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeHelpModal()">&times;</span>
            <h2>How to Save Photos</h2>
            <div class="save-instructions" id="saveInstructions"></div>
            <button class="button" onclick="closeHelpModal()">Got it!</button>
        </div>
    </div>

    <!-- Image Modal -->
    <div id="imageModal" class="image-modal">
        <div class="image-modal-content">
            <span id="imageCloseButton" class="image-modal-close" onclick="closeImageModal()">&times;</span>
            <img id="modalImage" src="" alt="Full size image">
            <div class="save-instruction-overlay">Press and hold on image to save to your device</div>
        </div>
    </div>
</div>

<script>
    // Global variables
    let googleReviewUrl = null;
    let globalMediaSendId = null;
    let globalInstagramHandle = '';
    let globalFacebookHandle = '';
    let globalTikTokHandle = '';
    let globalAISMSMessage = '';
    let globalAISocialCaption = '';
    let globalBeforePhotoIndices = [];
    let globalAfterPhotoIndices = [];

    // NEW: SDK Ready flags
    let facebookSDKReady = false;
    let instagramConnected = false;
    let facebookConnected = false;

    const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
    const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
    const isAndroid = /Android/i.test(navigator.userAgent);

    const SUPABASE_URL = 'https://mffqaqvjylkotkgvytro.supabase.co';
    const SUPABASE_API_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1mZnFhcXZqeWxrb3RrZ3Z5dHJvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDYxMTI5MzYsImV4cCI6MjA2MTY4ODkzNn0.oUlS-JS1G9OHjwv89xZY_QRqwsoI-GE8c-ZE_U2TjDc';

    // NEW: Initialize Facebook SDK
    window.fbAsyncInit = function() {
      FB.init({
        appId: FACEBOOK_CONFIG.appId,
        cookie: true,
        xfbml: true,
        version: FACEBOOK_CONFIG.version
      });

      facebookSDKReady = true;
      console.log('âœ… Facebook SDK initialized');
    };

    // NEW: Generate session hashtag for tracking
    function generateSessionHashtag() {
      const mediaSendId = getMediaSendId();
      if (!mediaSendId) {
        console.warn('No mediaSendId found for hashtag generation');
        return '#PostMyStyle';
      }
      return `#PostMyStyle${mediaSendId.substring(0, 8)}`;
    }

    // NEW: Create enhanced social caption with session hashtag
    function createEnhancedSocialCaption() {
      let enhancedCaption = '';

      // Use the caption from the page if available
      const originalCaption = document.getElementById('caption');
      if (originalCaption && originalCaption.textContent.trim() !== '') {
        enhancedCaption = originalCaption.textContent;
      } else if (globalAISocialCaption && globalAISocialCaption.trim() !== '') {
        enhancedCaption = globalAISocialCaption;
      }

      // Add salon handle if available
      if (globalInstagramHandle && globalInstagramHandle.trim() !== '') {
        const handle = globalInstagramHandle.startsWith('@') ? globalInstagramHandle : `@${globalInstagramHandle}`;
        enhancedCaption += `\n\nâœ¨ Styled by ${handle}`;
      }

      // Add session hashtag for tracking
      const sessionHashtag = generateSessionHashtag();
      enhancedCaption += `\n\n${sessionHashtag}`;

      console.log('ðŸŽ¯ Enhanced caption with session hashtag:', enhancedCaption);
      return enhancedCaption;
    }

    // NEW: Instagram Auto-Connect Functions
    async function connectAndPostInstagram() {
      const button = event.target;
      const originalText = button.textContent;

      try {
        // Update button state
        button.textContent = 'ðŸ”— Connecting...';
        button.className = button.className.replace('instagram-btn', 'connecting');
        button.disabled = true;

        showToast('Connecting to Instagram...', 3000);

        // Step 1: Instagram OAuth
        const authCode = await initiateInstagramOAuth();

        if (!authCode) {
          throw new Error('Instagram authorization cancelled');
        }

        // Step 2: Exchange code for access token
        button.textContent = 'ðŸ“¸ Getting Access...';
        const accessToken = await exchangeInstagramCode(authCode);

        // Step 3: Auto-post to Instagram
        button.textContent = 'ðŸš€ Posting...';
        const postResult = await autoPostToInstagram(accessToken);

        // Step 4: Update UGC tracking
        await recordAutoConnectUGC('instagram', postResult.postUrl, postResult.postId);

        // Success state
        button.textContent = 'âœ… Posted to Instagram!';
        button.className = button.className.replace('connecting', 'connected');
        showToast('ðŸŽ‰ Successfully posted to Instagram! Check your profile.', 5000);

        // Update progress
        updateProgress(2);

        // Mark as connected
        instagramConnected = true;

      } catch (error) {
        console.error('Instagram auto-connect error:', error);

        // Error state - fallback to manual flow
        button.textContent = 'ðŸ“± Use Manual Share';
        button.className = button.className.replace('connecting', 'manual-btn instagram-btn');
        button.onclick = () => doInstagramFlow();
        button.disabled = false;

        showToast(`Auto-connect failed: ${error.message}. Using manual sharing instead.`, 4000);

        // Automatically trigger manual flow
        setTimeout(() => {
          doInstagramFlow();
        }, 1500);
      }
    }

    // NEW: Facebook Auto-Connect Functions
    async function connectAndPostFacebook() {
      const button = event.target;
      const originalText = button.textContent;

      try {
        // Check if Facebook SDK is ready
        if (!facebookSDKReady) {
          throw new Error('Facebook SDK not ready');
        }

        // Update button state
        button.textContent = 'ðŸ”— Connecting...';
        button.className = button.className.replace('facebook-btn', 'connecting');
        button.disabled = true;

        showToast('Connecting to Facebook...', 3000);

        // Step 1: Facebook Login
        const loginResponse = await initiateFacebookLogin();

        if (!loginResponse || !loginResponse.authResponse) {
          throw new Error('Facebook authorization cancelled');
        }

        // Step 2: Auto-post to Facebook
        button.textContent = 'ðŸš€ Posting...';
        const postResult = await autoPostToFacebook(loginResponse.authResponse.accessToken);

        // Step 3: Update UGC tracking
        await recordAutoConnectUGC('facebook', postResult.postUrl, postResult.postId);

        // Success state
        button.textContent = 'âœ… Posted to Facebook!';
        button.className = button.className.replace('connecting', 'connected');
        showToast('ðŸŽ‰ Successfully posted to Facebook! Check your profile.', 5000);

        // Update progress
        updateProgress(2);

        // Mark as connected
        facebookConnected = true;

      } catch (error) {
        console.error('Facebook auto-connect error:', error);

        // Error state - fallback to manual flow
        button.textContent = 'ðŸ“± Use Manual Share';
        button.className = button.className.replace('connecting', 'manual-btn facebook-btn');
        button.onclick = () => doFacebookFlow();
        button.disabled = false;

        showToast(`Auto-connect failed: ${error.message}. Using manual sharing instead.`, 4000);

        // Automatically trigger manual flow
        setTimeout(() => {
          doFacebookFlow();
        }, 1500);
      }
    }

    // NEW: Instagram OAuth Implementation
    async function initiateInstagramOAuth() {
      return new Promise((resolve, reject) => {
        const state = generateRandomState();
        const authUrl = `https://api.instagram.com/oauth/authorize?` +
          `client_id=${INSTAGRAM_CONFIG.client_id}&` +
          `redirect_uri=${encodeURIComponent(INSTAGRAM_CONFIG.redirect_uri)}&` +
          `scope=${INSTAGRAM_CONFIG.scope}&` +
          `response_type=${INSTAGRAM_CONFIG.response_type}&` +
          `state=${state}`;

        // Open popup window
        const popup = window.open(authUrl, 'instagram-auth',
          'width=500,height=600,scrollbars=yes,resizable=yes');

        // Listen for popup completion
        const checkClosed = setInterval(() => {
          if (popup.closed) {
            clearInterval(checkClosed);
            // Check if we received the auth code
            const authCode = localStorage.getItem('instagram_auth_code');
            if (authCode) {
              localStorage.removeItem('instagram_auth_code');
              resolve(authCode);
            } else {
              reject(new Error('Authorization cancelled'));
            }
          }
        }, 1000);

        // Timeout after 5 minutes
        setTimeout(() => {
          if (!popup.closed) {
            popup.close();
            clearInterval(checkClosed);
            reject(new Error('Authorization timeout'));
          }
        }, 300000);
      });
    }

    // NEW: Facebook Login Implementation
    async function initiateFacebookLogin() {
      return new Promise((resolve, reject) => {
        FB.login(function(response) {
          if (response.authResponse) {
            resolve(response);
          } else {
            reject(new Error('Facebook login cancelled'));
          }
        }, {
          scope: 'publish_to_groups,user_posts'
        });
      });
    }

    // NEW: Exchange Instagram authorization code for access token
    async function exchangeInstagramCode(authCode) {
      // Call your Netlify function to handle the OAuth exchange
      const response = await fetch('/.netlify/functions/instagram-oauth', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          code: authCode,
          mediaSendId: getMediaSendId()
        })
      });

      if (!response.ok) {
        throw new Error('Failed to get Instagram access token');
      }

      const data = await response.json();
      return data.access_token;
    }

    // NEW: Auto-post to Instagram
    async function autoPostToInstagram(accessToken) {
      // Prepare post content
      const mediaUrls = Array.from(document.querySelectorAll('.media-item'))
        .map(img => img.getAttribute('data-watermarked-url') || img.src);

      const caption = createEnhancedSocialCaption();

      // Call your Netlify function to post
      const response = await fetch('/.netlify/functions/instagram-post', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          access_token: accessToken,
          image_url: mediaUrls[0], // Instagram API typically takes one image
          caption: caption,
          mediaSendId: getMediaSendId()
        })
      });

      if (!response.ok) {
        throw new Error('Failed to post to Instagram');
      }

      const result = await response.json();
      return {
        postId: result.id,
        postUrl: `https://instagram.com/p/${result.id}`
      };
    }

    // NEW: Auto-post to Facebook
    async function autoPostToFacebook(accessToken) {
      // Prepare post content
      const mediaUrls = Array.from(document.querySelectorAll('.media-item'))
        .map(img => img.getAttribute('data-watermarked-url') || img.src);

      const caption = createEnhancedSocialCaption();

      // Call your Netlify function to post
      const response = await fetch('/.netlify/functions/facebook-post', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          access_token: accessToken,
          message: caption,
          link: mediaUrls[0], // Facebook can handle image links
          mediaSendId: getMediaSendId()
        })
      });

      if (!response.ok) {
        throw new Error('Failed to post to Facebook');
      }

      const result = await response.json();
      return {
        postId: result.id,
        postUrl: `https://facebook.com/${result.id}`
      };
    }

    // NEW: Record auto-connect UGC with 100% confidence
    async function recordAutoConnectUGC(platform, postUrl, postId) {
      const mediaSendId = getMediaSendId();
      if (!mediaSendId) {
        console.error('No mediaSendId for UGC tracking');
        return;
      }

      try {
        const response = await fetch(`${SUPABASE_URL}/rest/v1/ugc_discoveries`, {
          method: 'POST',
          headers: {
            'apikey': SUPABASE_API_KEY,
            'Authorization': `Bearer ${SUPABASE_API_KEY}`,
            'Content-Type': 'application/json',
            'Prefer': 'return=representation'
          },
          body: JSON.stringify({
            media_send_id: mediaSendId,
            platform: platform,
            post_url: postUrl,
            post_id: postId,
            confidence_score: 1.0, // 100% confidence - we created it
            discovery_method: 'auto_connect',
            discovery_date: new Date().toISOString()
          })
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const result = await response.json();
        console.log('âœ… Auto-connect UGC recorded:', result);

        // Also update the counter in media_send
        reportShareToSupabase(`share_${platform}`, mediaSendId);

      } catch (error) {
        console.error('Failed to record auto-connect UGC:', error);
      }
    }

    // NEW: Generate random state for OAuth security
    function generateRandomState() {
      return Math.random().toString(36).substring(2, 15) +
             Math.random().toString(36).substring(2, 15);
    }

    // Utility functions
    function showToast(message, duration = 2000) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.style.display = 'block';
      setTimeout(() => {
        toast.style.display = 'none';
      }, duration);
    }

    function getURLParameters() {
      const params = new URLSearchParams(window.location.search);
      const result = {};
      for (const [key, value] of params.entries()) {
        result[key] = value;
      }
      return result;
    }

    function getFirstName(fullName) {
      if (!fullName) return '';
      return fullName.split(' ')[0];
    }

    function parsePhotoIndices(indicesData) {
      if (Array.isArray(indicesData)) {
        return indicesData.filter(num => typeof num === 'number' && num >= 0);
      }
      if (!indicesData || indicesData.trim() === '') {
        return [];
      }
      return indicesData.split(',').map(str => {
        const num = parseInt(str.trim());
        return isNaN(num) ? -1 : num;
      }).filter(num => num >= 0);
    }

    function getPhotoIndicatorType(photoIndex) {
      if (globalBeforePhotoIndices.includes(photoIndex)) {
        return 'before';
      }
      if (globalAfterPhotoIndices.includes(photoIndex)) {
        return 'after';
      }
      return 'none';
    }

    function createPhotoIndicator(photoIndex) {
      const indicatorType = getPhotoIndicatorType(photoIndex);
      const indicator = document.createElement('div');
      indicator.className = `photo-indicator ${indicatorType}`;

      switch (indicatorType) {
        case 'before':
          indicator.textContent = 'Before';
          break;
        case 'after':
          indicator.textContent = 'After';
          break;
        default:
          indicator.textContent = 'Photo';
          break;
      }

      return indicator;
    }

    function updateProgress(stepNumber) {
      document.querySelectorAll('.progress-step').forEach((step, index) => {
        if (index < stepNumber) {
          step.classList.add('completed');
          step.classList.remove('active');
        } else if (index === stepNumber - 1) {
          step.classList.add('active');
          step.classList.remove('completed');
        } else {
          step.classList.remove('active', 'completed');
        }
      });
    }

    // ENHANCED: Manual sharing flows with session hashtags
    function doInstagramFlow() {
      updateProgress(2);
      showToast('Preparing your Instagram post...');

      // 1. Save all photos (if not iOS)
      const mediaItems = document.querySelectorAll('.media-item');
      if (mediaItems.length > 0 && !isIOS) {
        mediaItems.forEach((item, index) => {
          setTimeout(() => {
            const downloadUrl = item.getAttribute('data-watermarked-url') ||
                               item.getAttribute('data-url') ||
                               item.src;
            directDownload(downloadUrl, `PostMyStyle-${index + 1}.jpg`);
          }, index * 300);
        });
      }

      // 2. Copy enhanced caption with session hashtag
      setTimeout(() => {
        const enhancedCaption = createEnhancedSocialCaption();
        copyToClipboard(enhancedCaption);
      }, 1000);

      // 3. Open Instagram or show instructions
      setTimeout(() => {
        if (isIOS) {
          showDirectSocialButton('Instagram', 'instagram');
        } else {
          openSocialPlatform('instagram');
        }
        trackSocialClick('instagram', getMediaSendId());
      }, 1500);
    }

    function doFacebookFlow() {
      updateProgress(2);
      showToast('Preparing your Facebook post...');

      const mediaItems = document.querySelectorAll('.media-item');
      if (mediaItems.length > 0 && !isIOS) {
        mediaItems.forEach((item, index) => {
          setTimeout(() => {
            const downloadUrl = item.getAttribute('data-watermarked-url') ||
                               item.getAttribute('data-url') ||
                               item.src;
            directDownload(downloadUrl, `PostMyStyle-${index + 1}.jpg`);
          }, index * 300);
        });
      }

      setTimeout(() => {
        const enhancedCaption = createEnhancedSocialCaption();
        copyToClipboard(enhancedCaption);

        if (isIOS) {
          showDirectSocialButton('Facebook', 'facebook');
        } else {
          openSocialPlatform('facebook');
        }
        trackSocialClick('facebook', getMediaSendId());
      }, 1500);
    }

    function doTikTokFlow() {
      updateProgress(2);
      showToast('Preparing your TikTok post...');

      const mediaItems = document.querySelectorAll('.media-item');
      if (mediaItems.length > 0 && !isIOS) {
        mediaItems.forEach((item, index) => {
          setTimeout(() => {
            const downloadUrl = item.getAttribute('data-watermarked-url') ||
                               item.getAttribute('data-url') ||
                               item.src;
            directDownload(downloadUrl, `PostMyStyle-${index + 1}.jpg`);
          }, index * 300);
        });
      }

      setTimeout(() => {
        const enhancedCaption = createEnhancedSocialCaption();
        copyToClipboard(enhancedCaption);

        if (isIOS) {
          showDirectSocialButton('TikTok', 'tiktok');
        } else {
          openSocialPlatform('tiktok');
        }
        trackSocialClick('tiktok', getMediaSendId());
      }, 1500);
    }

    function doReviewFlow() {
      updateProgress(3);

      if (googleReviewUrl) {
        showToast('Thank you! Opening review page...');
        setTimeout(() => {
          window.open(googleReviewUrl, '_blank');

          const productsSection = document.getElementById('productsSection');
          if (productsSection) {
            productsSection.scrollIntoView({ behavior: 'smooth' });
            productsSection.style.transform = 'scale(1.02)';
            productsSection.style.transition = 'transform 0.3s ease';
            setTimeout(() => {
              productsSection.style.transform = 'scale(1)';
            }, 1000);
          }

          reportShareToSupabase('google_review_clicks', getMediaSendId());
        }, 500);
      } else {
        const productsSection = document.getElementById('productsSection');
        if (productsSection) {
          productsSection.scrollIntoView({ behavior: 'smooth' });
          showToast('Check out the products used in your transformation!');
        }
      }
    }

    function showDirectSocialButton(platform, platformKey) {
      const clickedCard = document.querySelector(`.${platformKey}-card`);
      if (!clickedCard) {
        console.error(`Could not find ${platformKey}-card`);
        return;
      }

      const originalContent = clickedCard.innerHTML;
      const salonHandle = getSalonHandle(platformKey);
      const handleText = salonHandle ? ` and tag ${salonHandle.startsWith('@') ? salonHandle : '@' + salonHandle}` : '';

      clickedCard.innerHTML = `
        <div class="action-icon">
          <span style="font-size: 36px;">âœ…</span>
        </div>
        <h4 style="color: #4CAF50;">Ready to Share!</h4>
        <p style="color: #333;"><strong>Photos saved and caption ready!</strong><br>
        Tap below to open ${platform}${handleText}:</p>
        <button onclick="directOpenSocial('${platformKey}')"
                class="smart-action-btn ${platformKey}-btn"
                style="margin-top: 10px;">
          Open ${platform} Now
        </button>
      `;

      clickedCard.style.borderColor = '#4CAF50';
      clickedCard.style.transform = 'scale(1.02)';
      clickedCard.style.transition = 'all 0.3s ease';

      setTimeout(() => {
        if (clickedCard) {
          clickedCard.innerHTML = originalContent;
          clickedCard.style.borderColor = '';
          clickedCard.style.transform = '';
        }
      }, 20000);
    }

    function directOpenSocial(platform) {
      let urls = {};

      if (platform === 'instagram') {
        urls = {
          primary: 'https://instagram.com',
          fallback1: 'https://www.instagram.com/accounts/emailsignup/',
          fallback2: 'https://about.instagram.com'
        };
      } else if (platform === 'facebook') {
        urls = {
          primary: 'https://facebook.com',
          fallback1: 'https://www.facebook.com/reg/',
          fallback2: 'https://about.facebook.com'
        };
      } else if (platform === 'tiktok') {
        urls = {
          primary: 'https://tiktok.com',
          fallback1: 'https://www.tiktok.com/signup',
          fallback2: 'https://newsroom.tiktok.com'
        };
      }

      showToast(`Opening ${platform}...`);

      try {
        const newWindow = window.open(urls.primary, '_blank');

        setTimeout(() => {
          if (!newWindow || newWindow.closed) {
            showToast(`Primary URL blocked, trying alternative...`);
            setTimeout(() => {
              const fallbackWindow = window.open(urls.fallback1, '_blank');
              setTimeout(() => {
                if (!fallbackWindow || fallbackWindow.closed) {
                  showToast(`Trying final alternative...`);
                  setTimeout(() => {
                    window.open(urls.fallback2, '_blank');
                  }, 500);
                }
              }, 1000);
            }, 500);
          } else {
            showToast(`âœ… ${platform} opened successfully!`);
          }
        }, 1000);

      } catch (error) {
        console.error('Error in directOpenSocial:', error);
        showToast(`Error: ${error.message}`);
      }
    }

    function getSalonHandle(platform) {
      switch(platform) {
        case 'instagram': return globalInstagramHandle;
        case 'facebook': return globalFacebookHandle;
        case 'tiktok': return globalTikTokHandle;
        default: return '';
      }
    }

    // Modal functions
    function showHelpModal(event) {
      if (event) {
        event.stopPropagation();
      }
      const modal = document.getElementById('helpModal');
      const instructions = document.getElementById('saveInstructions');
      if (isIOS) {
        instructions.innerHTML = `
          <p>On your iPhone/iPad, there are two ways to save photos:</p>
          <ol>
            <li><strong>Tap any photo</strong> to view it full screen</li>
            <li>Then <strong>press and hold</strong> on the image</li>
            <li>Tap <strong>"Add to Photos"</strong> from the menu</li>
            <li>Tap the <strong>blue X button</strong> at the top right to return to this page</li>
          </ol>
          <p>Repeat for each photo you want to save.</p>
        `;
      } else if (isAndroid) {
        instructions.innerHTML = `
          <p>On your Android device:</p>
          <ol>
            <li><strong>Tap "Save Photo"</strong> under each image</li>
            <li>The photos will download automatically</li>
            <li>If prompted, select <strong>"Download"</strong></li>
            <li>You'll find the photos in your <strong>Downloads</strong> folder or <strong>Gallery</strong></li>
          </ol>
        `;
      } else {
        instructions.innerHTML = `
          <p>To save your photos:</p>
          <ol>
            <li><strong>Click "Save Photo"</strong> under each image</li>
            <li>The photos will download automatically to your device</li>
            <li>You can find them in your Downloads folder</li>
          </ol>
        `;
      }
      modal.style.display = 'block';
    }

    function closeHelpModal() {
      document.getElementById('helpModal').style.display = 'none';
    }

    function showImageModal(url) {
      const modal = document.getElementById('imageModal');
      const modalImg = document.getElementById('modalImage');
      modalImg.src = url;
      modal.style.display = 'block';
      const closeButton = document.getElementById('imageCloseButton');
      closeButton.style.display = 'block';
      if (isIOS) {
        showToast('Press and hold on the image to save it');
      }
    }

    function closeImageModal() {
      document.getElementById('imageModal').style.display = 'none';
    }

    function copyToClipboard(text) {
      if (isIOS) {
        showToast('Caption ready! Check below the social cards for your caption.', 4000);

        setTimeout(() => {
          const existingCaption = document.querySelector('.ios-caption-display');
          if (existingCaption) {
            existingCaption.remove();
          }

          const captionDisplay = document.createElement('div');
          captionDisplay.className = 'ios-caption-display social-instruction';
          captionDisplay.style.background = 'linear-gradient(135deg, rgba(59,130,246,0.1), rgba(99,102,241,0.1))';
          captionDisplay.style.borderColor = '#3b82f6';
          captionDisplay.style.marginTop = '15px';

          captionDisplay.innerHTML = `
            <div class="social-instruction-header">
              <span>ðŸ“‹</span>
              <h4>Your Caption (Tap to Select)</h4>
            </div>
            <div style="font-family: monospace; padding: 10px; background: white; border-radius: 8px; margin-top: 10px; user-select: all; -webkit-user-select: all; font-size: 14px; line-height: 1.4;" onclick="selectText(this)">
              ${text}
            </div>
            <p style="margin-top: 8px; font-size: 12px; color: #666; text-align: center;">
              <strong>Tip:</strong> Tap the text above, then "Select All" and "Copy"
            </p>
          `;

          const smartActions = document.querySelector('.smart-actions-container');
          if (smartActions) {
            smartActions.insertAdjacentElement('afterend', captionDisplay);

            setTimeout(() => {
              if (captionDisplay && captionDisplay.parentNode) {
                captionDisplay.remove();
              }
            }, 25000);
          }
        }, 500);
        return;
      }

      try {
        const textArea = document.createElement('textarea');
        textArea.value = text;
        document.body.appendChild(textArea);
        textArea.select();
        const copied = document.execCommand('copy');
        document.body.removeChild(textArea);
        if (copied) {
          showToast('Caption copied! Ready to paste in your social app.');
        } else {
          throw new Error('execCommand returned false');
        }
      } catch (err) {
        console.error('Fallback copy method error:', err);
        showToast('Could not copy automatically. Caption is shown below for manual copying.');
      }
    }

    function selectText(element) {
      if (document.selection) {
        const range = document.body.createTextRange();
        range.moveToElementText(element);
        range.select();
      } else if (window.getSelection) {
        const range = document.createRange();
        range.selectNode(element);
        window.getSelection().removeAllRanges();
        window.getSelection().addRange(range);
      }
    }

    function copyHashtags() {
      const originalCaption = document.getElementById('caption').textContent;
      copyToClipboard(originalCaption);
    }

    function isValidImageUrl(url) {
      if (!url || typeof url !== 'string') return false;
      return url.trim() !== '' &&
             (url.startsWith('http://') || url.startsWith('https://')) &&
             /\.(jpg|jpeg|png|gif|webp)$/i.test(url);
    }

    function processProductData(data) {
      console.log('ðŸ” PROCESSING PRODUCTS - DUAL FORMAT SUPPORT ðŸ”');
      console.log('Raw data received:', data);

      let productCount = 0;
      let products = [];

      if (data.products && Array.isArray(data.products)) {
        console.log('âœ… Found structured products array:', data.products);
        products = data.products;
        productCount = products.length;
        console.log(`ðŸ“Š Product count from array: ${productCount}`);
      } else {
        const urlProductCount = parseInt(data.productCount || '0');
        console.log(`ðŸ“Š Checking URL parameter format, count: ${urlProductCount}`);

        if (urlProductCount > 0) {
          for (let i = 1; i <= urlProductCount; i++) {
            const product = {
              id: data[`product${i}_id`],
              brand: data[`product${i}_brand`],
              name: data[`product${i}_name`],
              category: data[`product${i}_category`],
              affiliateUrl: data[`product${i}_affiliate_url`],
              notes: data[`product${i}_notes`],
              image: data[`product${i}_image`]
            };

            console.log(`URL Product ${i}:`, product);

            if (product.brand && product.name) {
              products.push(product);
            }
          }
          productCount = products.length;
        }
      }

      console.log(`ðŸŽ¯ Final product count: ${productCount}`);
      console.log(`ðŸŽ¯ Final products array:`, products);

      const productsSection = document.getElementById('productsSection');
      const productsGrid = document.getElementById('productsGrid');

      if (productCount === 0) {
        console.log('âŒ No valid products found');
        productsSection.style.display = 'none';
        return;
      }

      productsGrid.innerHTML = '';

      const intro = document.createElement('div');
      intro.className = 'products-intro';
      intro.innerHTML = `
        <img src="amazon.png" alt="Shop" class="amazon-icon" onerror="this.onerror=null; this.src='data:image/svg+xml;utf8,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%2224%22 height=%2224%22><rect width=%2224%22 height=%2224%22 rx=%2212%22 fill=%22%23FF9900%22/><text x=%2212%22 y=%2216%22 font-size=%2214%22 text-anchor=%22middle%22 fill=%22white%22>ðŸ›’</text></svg>'"/>
        <div class="products-intro-content">
          <h3>Recreate Your Look at Home</h3>
          <p>These are the exact professional products your stylist used:</p>
        </div>
      `;
      productsGrid.appendChild(intro);

      products.forEach((product, index) => {
        console.log(`\n--- ðŸ›ï¸ PROCESSING PRODUCT ${index + 1} ---`);
        console.log('Product object:', product);

        const { brand, name, category, affiliateUrl, notes, image } = product;

        console.log(`Brand: "${brand}"`);
        console.log(`Name: "${name}"`);
        console.log(`Affiliate URL: "${affiliateUrl}"`);
        console.log(`Image URL: "${image}"`);

        if (brand && name) {
          const card = document.createElement('div');
          card.className = 'product-card';

          let productImageHtml = '';
          if (isValidImageUrl(image)) {
            productImageHtml = `<img src="${image}" alt="${name}" />`;
            console.log('âœ… Using product image:', image);
          } else {
            productImageHtml = `<img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA2MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjYwIiBoZWlnaHQ9IjYwIiBmaWxsPSIjRjBGMEYwIi8+CjxwYXRoIGQ9Ik0yMCAyNkgyNlYzMkgyMFYyNloiIGZpbGw9IiM5OTk5OTkiLz4KPHBhdGggZD0iTTMwIDIySDM2VjI4SDMwVjIyWiIgZmlsbD0iIzk5OTk5OSIvPgo8dGV4dCB4PSIzMCIgeT0iNDUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSI4IiBmaWxsPSIjOTk5OTk5IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIj5OTyBJTUFHRTwvdGV4dD4KPHR4dCB4PSIzMCIgeT0iNTQiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSI2IiBmaWxsPSIjOTk5OTk5IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIj5BVkFJTEFCTEU8L3RleHQ+Cjwvc3ZnPgo=" alt="No image available" style="opacity: 0.7;" />`;
            console.log('âŒ Using NO IMAGE placeholder');
          }

          const hasValidUrl = affiliateUrl &&
                             typeof affiliateUrl === 'string' &&
                             affiliateUrl.trim() !== '' &&
                             (affiliateUrl.includes('http://') || affiliateUrl.includes('https://'));

          console.log(`ðŸ”— Has valid URL: ${hasValidUrl}`);

          let buttonHtml;
          if (hasValidUrl) {
            buttonHtml = `
              <a href="${affiliateUrl}"
                 target="_blank"
                 rel="noopener noreferrer"
                 class="product-button"
                 onclick="console.log('ðŸ›’ Product clicked:', '${brand}', '${affiliateUrl}'); trackProductClick('${brand}', '${name}', ${index + 1}); return true;">
                ðŸ›’ Get This Product
              </a>`;
          } else {
            buttonHtml = `
              <div class="product-button product-button-disabled">
                ðŸ’¼ Professional Product
              </div>`;
          }

          card.innerHTML = `
            <div class="product-header">
              <div class="product-image">
                ${productImageHtml}
              </div>
              <div class="product-info">
                <div class="product-brand">${brand}</div>
                <div class="product-name">${name}</div>
                <div class="product-category">${category || 'Product'}</div>
              </div>
            </div>
            <div class="product-description">
              ${notes || 'Professional-grade product used in your styling session.'}
            </div>
            ${buttonHtml}
          `;

          productsGrid.appendChild(card);
          console.log(`âœ… Added product: ${brand} ${name} (${hasValidUrl ? 'CLICKABLE' : 'DISABLED'})`);
        } else {
          console.log(`âŒ Skipping product - missing brand (${!!brand}) or name (${!!name})`);
        }
      });

      productsSection.style.display = 'block';
      console.log('ðŸŽ‰ Products section displayed');
      console.log('ðŸ” END DUAL FORMAT PROCESSING ðŸ”\n');
    }

    function generateTrackingId() {
      return 'pms_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }

    async function trackProductClick(brand, name, index) {
      console.log(`ðŸ›’ Product click tracked: ${brand} ${name} (index: ${index})`);
      showToast(`Opening ${brand} ${name}...`);

      const mediaSendId = getMediaSendId();
      if (!mediaSendId) {
        console.error('No mediaSendId found for detailed tracking');
        return true;
      }

      const trackingId = generateTrackingId();

      try {
        const productCards = document.querySelectorAll('.product-card');
        const productCard = productCards[index - 1];

        let productData = {
          brand: brand,
          name: name,
          category: 'Product',
          productUrl: null
        };

        if (productCard) {
          const categoryElement = productCard.querySelector('.product-category');
          const linkElement = productCard.querySelector('.product-button');

          if (categoryElement) {
            productData.category = categoryElement.textContent.trim();
          }

          if (linkElement && linkElement.href) {
            productData.productUrl = linkElement.href;
          }
        }

        await recordProductInteraction({
          mediaSendId: mediaSendId,
          trackingId: trackingId,
          productBrand: productData.brand,
          productName: productData.name,
          productCategory: productData.category,
          productUrl: productData.productUrl
        });

        reportShareToSupabase('product_clicks', mediaSendId);

        console.log(`ðŸ“Š Detailed tracking recorded with ID: ${trackingId}`);

      } catch (error) {
        console.error('Error in detailed product tracking:', error);
        reportShareToSupabase('product_clicks', mediaSendId);
      }

      return true;
    }

    async function recordProductInteraction(data) {
      try {
        const response = await fetch(`${SUPABASE_URL}/rest/v1/product_interactions`, {
          method: 'POST',
          headers: {
            'apikey': SUPABASE_API_KEY,
            'Authorization': `Bearer ${SUPABASE_API_KEY}`,
            'Content-Type': 'application/json',
            'Prefer': 'return=representation'
          },
          body: JSON.stringify({
            media_send_id: data.mediaSendId,
            tracking_id: data.trackingId,
            product_brand: data.productBrand,
            product_name: data.productName,
            product_category: data.productCategory,
            product_url: data.productUrl,
            user_agent: navigator.userAgent
          })
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const result = await response.json();
        console.log('Product interaction recorded:', result);

      } catch (error) {
        console.error('Failed to record product interaction:', error);
        throw error;
      }
    }

    function createWatermarkedImageElement(url, salonName, index) {
      const container = document.createElement('div');
      container.className = 'media-container';

      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');

      const img = document.createElement('img');
      img.src = url;
      img.alt = 'Your New Style';
      img.className = 'media-item';
      img.setAttribute('data-index', index);
      img.setAttribute('data-url', url);
      img.crossOrigin = 'anonymous';

      img.onload = function() {
        try {
          canvas.width = img.naturalWidth;
          canvas.height = img.naturalHeight;

          ctx.drawImage(img, 0, 0);

          const fontSize = Math.max(20, canvas.width * 0.025);
          ctx.font = `bold ${fontSize}px Arial, sans-serif`;
          ctx.textAlign = 'left';

          const padding = Math.max(15, canvas.width * 0.02);
          const textWidth = ctx.measureText(salonName).width;
          const x = padding;
          const y = canvas.height - padding;

          ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
          ctx.fillRect(x - 8, y - fontSize - 3, textWidth + 16, fontSize + 10);

          ctx.fillStyle = 'white';
          ctx.fillText(salonName, x, y - 3);

          canvas.toBlob(function(blob) {
            if (blob) {
              const watermarkedUrl = URL.createObjectURL(blob);
              img.setAttribute('data-watermarked-url', watermarkedUrl);
              console.log(`âœ… Watermarked image created for: ${salonName}`);
            }
          }, 'image/jpeg', 0.92);

        } catch (error) {
          console.error('Canvas watermarking failed:', error);
          img.setAttribute('data-watermarked-url', url);
        }
      };

      img.style.cursor = 'pointer';
      img.onclick = function() {
        const displayUrl = img.getAttribute('data-watermarked-url') || url;
        showImageModal(displayUrl);
      };

      const watermark = document.createElement('div');
      watermark.className = 'watermark';
      watermark.textContent = salonName;

      const saveButtonContainer = document.createElement('div');
      saveButtonContainer.className = 'media-actions';
      const saveButton = document.createElement('button');
      saveButton.className = 'save-button';
      saveButton.textContent = 'Save Photo';
      saveButton.id = `saveButton${index}`;
      saveButton.onclick = function() {
        const downloadUrl = img.getAttribute('data-watermarked-url') || url;
        savePhoto(downloadUrl, index, this);
      };
      saveButtonContainer.appendChild(saveButton);

      const photoIndicator = createPhotoIndicator(index - 1);
      saveButtonContainer.appendChild(photoIndicator);

      img.onerror = function() {
        this.onerror = null;
        this.src = 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="150" height="150"><rect width="150" height="150" fill="%23f5f5f5"/><text x="75" y="75" font-size="14" text-anchor="middle" fill="%23999">Image Error</text></svg>';
      };

      container.appendChild(img);
      container.appendChild(watermark);
      const wrapper = document.createElement('div');
      wrapper.appendChild(container);
      wrapper.appendChild(saveButtonContainer);

      return wrapper;
    }

    function directDownload(url, filename) {
      try {
        fetch(url)
          .then(response => response.blob())
          .then(blob => {
            const blobUrl = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = blobUrl;
            link.download = filename;
            link.style.display = 'none';
            document.body.appendChild(link);
            link.click();
            setTimeout(() => {
              URL.revokeObjectURL(blobUrl);
              document.body.removeChild(link);
            }, 100);
          })
          .catch(err => {
            console.error('Direct download failed:', err);
            if (isIOS) {
              window.open(url, '_blank');
            }
          });
      } catch (err) {
        console.error('Error in directDownload:', err);
        if (isIOS) {
          window.open(url, '_blank');
        }
      }
    }

    function savePhoto(url, index, button) {
      if (button) {
        button.textContent = 'Saving...';
        button.className = 'save-button saving';
        button.disabled = true;
      }
      try {
        if (isIOS) {
          showImageModal(url);
          if (button) {
            setTimeout(() => {
              button.textContent = 'Save Photo';
              button.className = 'save-button';
              button.disabled = false;
            }, 1000);
          }
          return;
        }
        directDownload(url, `PostMyStyle-${index}.jpg`);
        if (button) {
          button.textContent = 'Saved!';
          button.className = 'save-button saved';
          setTimeout(() => {
            button.textContent = 'Save Photo';
            button.className = 'save-button';
            button.disabled = false;
          }, 2000);
        }
        showToast(`Saving photo ${index}...`);
      } catch (error) {
        console.error('Error saving photo:', error);
        if (button) {
          button.textContent = 'Retry';
          button.className = 'save-button error';
          button.disabled = false;
        }
        showToast('Could not save photo. Please try again.');
      }
    }

    function saveAllPhotos() {
      const mediaItems = document.querySelectorAll('.media-item');
      if (mediaItems.length === 0) {
        showToast('No photos to save');
        return;
      }
      if (isIOS) {
        showHelpModal();
        return;
      }
      showToast(`Saving ${mediaItems.length} watermarked photos...`);
      mediaItems.forEach((item, index) => {
        setTimeout(() => {
          const buttonId = `saveButton${index + 1}`;
          const button = document.getElementById(buttonId);
          const downloadUrl = item.getAttribute('data-watermarked-url') ||
                             item.getAttribute('data-url') ||
                             item.src;
          savePhoto(downloadUrl, index + 1, button);
        }, index * 800);
      });
    }

    function getMediaSendId() {
      if (globalMediaSendId) {
        return globalMediaSendId;
      }
      const urlParams = new URLSearchParams(window.location.search);
      const urlMediaSendId = urlParams.get('mediaSendId');
      if (urlMediaSendId) {
        return urlMediaSendId;
      }
      return null;
    }

    function trackSocialClick(platform, mediaSendId) {
      if (!mediaSendId) {
        console.error('No mediaSendId for social tracking');
        return;
      }

      console.log(`Tracking ${platform} with mediaSendId:`, mediaSendId);

      switch(platform) {
        case 'instagram':
          reportShareToSupabase('share_instagram', mediaSendId);
          break;
        case 'facebook':
          reportShareToSupabase('share_facebook', mediaSendId);
          break;
        case 'tiktok':
          reportShareToSupabase('share_tiktok', mediaSendId);
          break;
      }
    }

    function openSocialPlatform(platform) {
      const urls = {
        'instagram': 'https://www.instagram.com/',
        'facebook': 'https://www.facebook.com/',
        'tiktok': 'https://www.tiktok.com/'
      };

      const url = urls[platform];
      if (url) {
        console.log(`ðŸ”— Opening ${platform} for user content creation`);
        window.open(url, '_blank');
      }
    }

    async function processPageData(data) {
      console.log('processPageData called with:', data);

      document.getElementById('loading').style.display = 'none';
      document.getElementById('content').style.display = 'block';

      let parsedData = data;
      if (typeof data.data === 'string' && data.data_parsed) {
        parsedData = data.data_parsed;
      }

      console.log('Final parsed data for processing:', parsedData);

      const fullClientName = parsedData.clientName || getURLParameters().clientName || '';
      const clientName = getFirstName(fullClientName);
      const salonName = parsedData.salonName || getURLParameters().salonName || 'Salon';
      const googlePlaceId = parsedData.google_place_id || getURLParameters().google_place_id;
      googleReviewUrl = googlePlaceId ? `https://search.google.com/local/writereview?placeid=${googlePlaceId}` : null;
      const stylistName = parsedData.stylistName || getURLParameters().stylistName || 'Stylist';
      const caption = parsedData.caption || getURLParameters().caption || '';

      globalInstagramHandle = parsedData.instagram_handle || getURLParameters().instagram_handle || '';
      globalFacebookHandle = parsedData.facebook_handle || getURLParameters().facebook_handle || '';
      globalTikTokHandle = parsedData.tiktok_handle || getURLParameters().tiktok_handle || '';

      globalAISMSMessage = parsedData.aiSMSMessage || getURLParameters().ai_sms_message || '';
      globalAISocialCaption = parsedData.aiSocialCaption || getURLParameters().ai_social_caption || '';

      const beforeIndicesData = parsedData.beforePhotoIndices || getURLParameters().before_photo_indices || '';
      const afterIndicesData = parsedData.afterPhotoIndices || getURLParameters().after_photo_indices || '';

      globalBeforePhotoIndices = parsePhotoIndices(beforeIndicesData);
      globalAfterPhotoIndices = parsePhotoIndices(afterIndicesData);

      console.log('ðŸ”— Social Media Handles:');
      console.log(`Instagram: "${globalInstagramHandle}"`);
      console.log(`Facebook: "${globalFacebookHandle}"`);
      console.log(`TikTok: "${globalTikTokHandle}"`);
      console.log('ðŸ¤– AI Messages:');
      console.log(`SMS Message: "${globalAISMSMessage}"`);
      console.log(`Social Caption: "${globalAISocialCaption}"`);
      console.log('ðŸ“¸ Before/After Photo Indices:');
      console.log(`Before Photos: [${globalBeforePhotoIndices.join(', ')}]`);
      console.log(`After Photos: [${globalAfterPhotoIndices.join(', ')}]`);

      const headerElement = document.getElementById('dynamic-header');
      if (salonName && stylistName && salonName !== 'Salon' && stylistName !== 'Stylist') {
        headerElement.textContent = `${salonName} and ${stylistName} Would Love If You Could Share Your New Look!`;
      } else if (salonName && salonName !== 'Salon') {
        headerElement.textContent = `${salonName} Would Love If You Could Share Your New Look!`;
      } else if (stylistName && stylistName !== 'Stylist') {
        headerElement.textContent = `${stylistName} Would Love If You Could Share Your New Look!`;
      } else {
        headerElement.textContent = 'Share Your New Look!';
      }

      if (globalAISMSMessage && globalAISMSMessage.trim() !== '') {
        const aiMessageContainer = document.createElement('div');
        aiMessageContainer.className = 'ai-message-container';
        aiMessageContainer.innerHTML = `
          <div class="ai-message-header">
            <span>ðŸ’•</span>
            <h4>Personal Message from ${stylistName}</h4>
          </div>
          <p class="ai-message-text">"${globalAISMSMessage}"</p>
        `;

        const progressContainer = document.querySelector('.progress-container');
        if (progressContainer) {
          progressContainer.insertAdjacentElement('beforebegin', aiMessageContainer);
        }
      } else if (clientName) {
        document.getElementById('personal-message').textContent = `${clientName}, you look fantastic! Post your style and let your friends know! I've also included the products we used if you decide to use them at home.`;
      } else {
        document.getElementById('personal-message').textContent = "You look fantastic! Post your style and let your friends know! I've also included the products we used if you decide to use them at home.";
      }

      if (caption) {
        const captionElement = document.createElement('div');
        captionElement.id = 'caption';
        captionElement.textContent = caption;

        const saveSection = document.querySelector('.save-your-style-section');
        const smartActionsSection = document.querySelector('.smart-actions-container');

        const captionSection = document.createElement('div');
        captionSection.style.margin = '20px 0';
        captionSection.innerHTML = `
          <h3 style="text-align: center; color: #333; margin-bottom: 15px;">ðŸ“‹ Your Caption</h3>
          <div id="caption" style="margin: 15px auto; padding: 15px; background: #f5f5f5; border-radius: 8px; font-family: 'Courier New', monospace; color: #333; max-width: 100%; box-sizing: border-box;">${caption}</div>
        `;

        saveSection.insertAdjacentElement('afterend', captionSection);
      }

      processProductData(parsedData);

      const mediaGrid = document.getElementById('mediaGrid');
      mediaGrid.innerHTML = '';
      let index = 1;
      let mediaCount = 0;
      while (parsedData[`mediaUrl${index}`] || getURLParameters()[`mediaUrl${index}`]) {
        const url = parsedData[`mediaUrl${index}`] || getURLParameters()[`mediaUrl${index}`];
        if (url) {
          mediaCount++;
          const fileType = url.split('.').pop().toLowerCase();
          const isVideo = fileType === 'mp4' || fileType === 'mov' || fileType === 'webm';
          if (isVideo) {
            const container = document.createElement('div');
            container.className = 'media-container';
            const video = document.createElement('video');
            video.src = url;
            video.className = 'media-item';
            video.controls = true;
            video.setAttribute('data-url', url);
            const watermark = document.createElement('div');
            watermark.className = 'watermark';
            watermark.textContent = salonName;
            const saveButtonContainer = document.createElement('div');
            saveButtonContainer.className = 'media-actions';
            const saveButton = document.createElement('button');
            saveButton.className = 'save-button';
            saveButton.textContent = 'Save Video';
            saveButton.id = `saveButton${index}`;
            saveButton.onclick = function() {
              savePhoto(url, index, this);
            };
            saveButtonContainer.appendChild(saveButton);

            const photoIndicator = createPhotoIndicator(index - 1);
            saveButtonContainer.appendChild(photoIndicator);

            container.appendChild(video);
            container.appendChild(watermark);
            const wrapper = document.createElement('div');
            wrapper.appendChild(container);
            wrapper.appendChild(saveButtonContainer);
            mediaGrid.appendChild(wrapper);
          } else {
            const imageElement = createWatermarkedImageElement(url, salonName, index);
            mediaGrid.appendChild(imageElement);
          }
        }
        index++;
      }
      if (mediaCount === 0) {
        const noMedia = document.createElement('p');
        noMedia.textContent = 'No photos or videos found';
        noMedia.style.color = '#888';
        mediaGrid.appendChild(noMedia);
      }
      if (isIOS && mediaCount > 0) {
        const instruction = document.createElement('div');
        instruction.className = 'instruction';
        instruction.innerHTML = '<strong>Tip:</strong> Tap any photo to view it larger, then press and hold to save it to your Photos. Your salon watermark is embedded in each image! Look for the <strong>blue X button</strong> to return to this page.';
        mediaGrid.parentNode.insertBefore(instruction, mediaGrid);
      }

      if ((isIOS || isAndroid) && mediaCount > 0) {
        const instagramTip = document.createElement('div');
        instagramTip.className = 'instruction';
        instagramTip.style.marginTop = '15px';
        instagramTip.innerHTML = `
          <strong>ðŸ“¸ For Social Media:</strong>
          Your saved photos include the <strong>${salonName}</strong> watermark embedded permanently.
          Perfect for sharing your new look across all social media platforms!
        `;
        mediaGrid.parentNode.appendChild(instagramTip);
      }

      if (globalBeforePhotoIndices.length > 0 || globalAfterPhotoIndices.length > 0) {
        const beforeAfterTip = document.createElement('div');
        beforeAfterTip.className = 'instruction';
        beforeAfterTip.style.marginTop = '15px';
        beforeAfterTip.style.background = 'linear-gradient(135deg, rgba(76, 175, 80, 0.1), rgba(33, 150, 243, 0.1))';
        beforeAfterTip.style.borderLeft = '4px solid #4CAF50';

        let tipText = '<strong>ðŸ”„ Before & After Photos:</strong> ';

        if (globalBeforePhotoIndices.length > 0 && globalAfterPhotoIndices.length > 0) {
          tipText += `Your stylist has marked ${globalBeforePhotoIndices.length} "Before" photo${globalBeforePhotoIndices.length > 1 ? 's' : ''} and ${globalAfterPhotoIndices.length} "After" photo${globalAfterPhotoIndices.length > 1 ? 's' : ''} to showcase your amazing transformation! Share the ones you love most.`;
        } else if (globalBeforePhotoIndices.length > 0) {
          tipText += `Your stylist has marked ${globalBeforePhotoIndices.length} "Before" photo${globalBeforePhotoIndices.length > 1 ? 's' : ''} showing your starting point.`;
        } else if (globalAfterPhotoIndices.length > 0) {
          tipText += `Your stylist has marked ${globalAfterPhotoIndices.length} "After" photo${globalAfterPhotoIndices.length > 1 ? 's' : ''} showcasing your beautiful results.`;
        }

        beforeAfterTip.innerHTML = tipText;
        mediaGrid.parentNode.appendChild(beforeAfterTip);
      }
    }

    async function reportShareToSupabase(fieldName, mediaSendId) {
      if (!mediaSendId) {
        console.error('No mediaSendId found, cannot report to Supabase.');
        return;
      }
      try {
        console.log(`Updating Supabase: Field ${fieldName} for ID ${mediaSendId}`);
        const getResponse = await fetch(`${SUPABASE_URL}/rest/v1/media_send?id=eq.${mediaSendId}&select=${fieldName}`, {
          method: 'GET',
          headers: {
            'apikey': SUPABASE_API_KEY,
            'Authorization': `Bearer ${SUPABASE_API_KEY}`,
            'Content-Type': 'application/json'
          }
        });
        if (!getResponse.ok) {
          console.error('Failed to get current value:', getResponse.status);
          return;
        }
        const data = await getResponse.json();
        const currentValue = data[0] && data[0][fieldName] ? data[0][fieldName] : 0;
        const newValue = currentValue + 1;
        const updateResponse = await fetch(`${SUPABASE_URL}/rest/v1/media_send?id=eq.${mediaSendId}`, {
          method: 'PATCH',
          headers: {
            'apikey': SUPABASE_API_KEY,
            'Authorization': `Bearer ${SUPABASE_API_KEY}`,
            'Content-Type': 'application/json',
            'Prefer': 'return=representation'
          },
          body: JSON.stringify({ [fieldName]: newValue })
        });
        if (!updateResponse.ok) {
          console.error('Supabase update error:', updateResponse.status, await updateResponse.text());
        } else {
          console.log(`Successfully updated ${fieldName} to ${newValue} in Supabase`);
        }
      } catch (error) {
        console.error('Failed to update Supabase:', error);
      }
    }

    function handleMobileBranchFlow() {
      let attempts = 0;
      const maxAttempts = 20;

      function tryBranchData() {
        attempts++;
        console.log(`Branch attempt ${attempts}/${maxAttempts}`);

        if (typeof branch === 'undefined') {
          if (attempts < maxAttempts) {
            setTimeout(tryBranchData, 500);
          } else {
            console.error('Branch SDK timeout');
            processPageData(getURLParameters());
          }
          return;
        }

        branch.data(function(err, data) {
          console.log('Branch callback executed');
          console.log('Branch data:', data);

          if (err || !data) {
            console.error('Branch error:', err);
            processPageData(getURLParameters());
            return;
          }

          if (data.data_parsed && data.data_parsed.mediaSendId) {
            console.log('Found mediaSendId in Branch data_parsed:', data.data_parsed.mediaSendId);
            globalMediaSendId = data.data_parsed.mediaSendId;
            reportShareToSupabase('click_count', data.data_parsed.mediaSendId);
            processPageData(data.data_parsed);
          } else {
            console.log('No mediaSendId in Branch data_parsed');
            processPageData(getURLParameters());
          }
        });
      }

      tryBranchData();
    }

    document.getElementById('imageModal').addEventListener('click', function(event) {
      if (event.target === this) {
        closeImageModal();
      }
    });

    document.addEventListener('DOMContentLoaded', function() {
      console.log('=== PAGE LOADED ===');
      console.log('Current URL:', window.location.href);

      const urlParams = new URLSearchParams(window.location.search);
      const urlMediaSendId = urlParams.get('mediaSendId');
      const hasBranchParams = urlParams.has('_branch_match_id') || urlParams.has('_branch_referrer');

      console.log('URL mediaSendId:', urlMediaSendId);
      console.log('Has Branch parameters:', hasBranchParams);

      if (urlMediaSendId) {
        console.log('Desktop flow - using URL parameters');
        globalMediaSendId = urlMediaSendId;
        reportShareToSupabase('click_count', urlMediaSendId);

        const urlData = getURLParameters();
        console.log('URL data for processing:', urlData);
        processPageData(urlData);
      } else if (hasBranchParams) {
        console.log('Mobile Branch flow - waiting for Branch SDK');
        handleMobileBranchFlow();
      } else {
        console.log('No mediaSendId or Branch parameters found');
        const loadingTimeout = setTimeout(() => {
          const urlData = getURLParameters();
          console.log('Fallback - using URL data:', urlData);
          processPageData(urlData);
        }, 5000);

        if (typeof branch !== 'undefined' && branch.data) {
          branch.data(function(err, data) {
            clearTimeout(loadingTimeout);
            if (err || !data || Object.keys(data).length === 0) {
              console.log('No Branch data found. Using URL parameters.');
              const urlData = getURLParameters();
              console.log('Branch fallback - using URL data:', urlData);
              processPageData(urlData);
            } else {
              console.log('Branch data received:', data);
              if (data.mediaSendId) {
                globalMediaSendId = data.mediaSendId;
                reportShareToSupabase('click_count', data.mediaSendId);
              }
              processPageData(data);
            }
          });
        } else {
          clearTimeout(loadingTimeout);
          const urlData = getURLParameters();
          console.log('No Branch SDK - using URL data:', urlData);
          processPageData(urlData);
        }
      }
    });
</script>
</body>
</html>